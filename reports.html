<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo thống kê - Hệ thống quản lý thư viện</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="css/style.css">

    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stats-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stats-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stats-card.danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .report-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .report-table .table {
            margin-bottom: 0;
        }

        .report-table .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px;
        }

        .report-table .table tbody td {
            padding: 12px 15px;
            border-color: #f0f0f0;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-stable {
            color: #6c757d;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .period-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-chart {
            height: 400px;
        }

        .top-items-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .top-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .top-item:last-child {
            border-bottom: none;
        }

        .rank-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        }

        .loading-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }

            .export-buttons {
                justify-content: center;
            }

            .chart-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-chart-bar"></i> Báo cáo thống kê
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="readers.html">
                            <i class="fas fa-users"></i> Độc giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="books.html">
                            <i class="fas fa-book"></i> Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="borrow-return.html">
                            <i class="fas fa-exchange-alt"></i> Mượn/Trả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="reports.html">
                            <i class="fas fa-chart-bar"></i> Báo cáo
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="currentUser">Admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog"></i> Cài đặt</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-chart-bar text-primary"></i> Báo cáo thống kê</h2>
                        <p class="text-muted">Theo dõi và phân tích hoạt động thư viện</p>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-success" onclick="exportAllReports()">
                            <i class="fas fa-download"></i> Xuất tất cả
                        </button>
                        <button class="btn btn-primary" onclick="printReport()">
                            <i class="fas fa-print"></i> In báo cáo
                        </button>
                        <button class="btn btn-info" onclick="scheduleReport()">
                            <i class="fas fa-clock"></i> Lập lịch
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="period-selector">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Khoảng thời gian:</label>
                            <select class="form-select" id="periodSelect" onchange="updateReports()">
                                <option value="today">Hôm nay</option>
                                <option value="week">Tuần này</option>
                                <option value="month" selected>Tháng này</option>
                                <option value="quarter">Quý này</option>
                                <option value="year">Năm này</option>
                                <option value="custom">Tùy chọn</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="customDateRange" style="display: none;">
                            <label class="form-label">Từ ngày:</label>
                            <input type="date" class="form-control" id="fromDate">
                        </div>
                        <div class="col-md-3" id="customDateRange2" style="display: none;">
                            <label class="form-label">Đến ngày:</label>
                            <input type="date" class="form-control" id="toDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">So sánh với:</label>
                            <select class="form-select" id="compareSelect" onchange="updateComparison()">
                                <option value="none">Không so sánh</option>
                                <option value="previous">Kỳ trước</option>
                                <option value="lastYear">Cùng kỳ năm trước</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="quick-stats">
            <div class="stats-card">
                <div class="stats-number" id="totalBorrows">0</div>
                <div class="stats-label">
                    <i class="fas fa-book-open"></i> Lượt mượn sách
                </div>
                <div class="trend-indicator" id="borrowTrend">
                    <i class="fas fa-arrow-up"></i> +12% so với kỳ trước
                </div>
            </div>

            <div class="stats-card success">
                <div class="stats-number" id="totalReturns">0</div>
                <div class="stats-label">
                    <i class="fas fa-undo"></i> Lượt trả sách
                </div>
                <div class="trend-indicator" id="returnTrend">
                    <i class="fas fa-arrow-up"></i> +8% so với kỳ trước
                </div>
            </div>

            <div class="stats-card warning">
                <div class="stats-number" id="overdueBooks">0</div>
                <div class="stats-label">
                    <i class="fas fa-exclamation-triangle"></i> Sách quá hạn
                </div>
                <div class="trend-indicator" id="overdueTrend">
                    <i class="fas fa-arrow-down"></i> -5% so với kỳ trước
                </div>
            </div>

            <div class="stats-card info">
                <div class="stats-number" id="activeReaders">0</div>
                <div class="stats-label">
                    <i class="fas fa-users"></i> Độc giả hoạt động
                </div>
                <div class="trend-indicator" id="readerTrend">
                    <i class="fas fa-arrow-up"></i> +15% so với kỳ trước
                </div>
            </div>

            <div class="stats-card danger">
                <div class="stats-number" id="totalFines">0đ</div>
                <div class="stats-label">
                    <i class="fas fa-money-bill-wave"></i> Tổng phí phạt
                </div>
                <div class="trend-indicator" id="fineTrend">
                    <i class="fas fa-arrow-down"></i> -10% so với kỳ trước
                </div>
            </div>

            <div class="stats-card">
                <div class="stats-number" id="renewalCount">0</div>
                <div class="stats-label">
                    <i class="fas fa-calendar-plus"></i> Lượt gia hạn
                </div>
                <div class="trend-indicator" id="renewalTrend">
                    <i class="fas fa-minus"></i> Không đổi
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title">
                            <i class="fas fa-chart-line text-primary"></i>
                            Xu hướng mượn/trả sách
                        </h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="trendChart" id="daily" checked>
                            <label class="btn btn-outline-primary btn-sm" for="daily">Ngày</label>

                            <input type="radio" class="btn-check" name="trendChart" id="weekly">
                            <label class="btn btn-outline-primary btn-sm" for="weekly">Tuần</label>

                            <input type="radio" class="btn-check" name="trendChart" id="monthly">
                            <label class="btn btn-outline-primary btn-sm" for="monthly">Tháng</label>
                        </div>
                    </div>
                    <canvas id="borrowReturnChart" height="100"></canvas>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie text-success"></i>
                        Phân bố theo thể loại
                    </h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar text-info"></i>
                        Hoạt động theo lớp
                    </h5>
                    <canvas id="classActivityChart"></canvas>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-area text-warning"></i>
                        So sánh theo tháng
                    </h5>
                    <canvas id="monthlyComparisonChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-4">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title">
                            <i class="fas fa-trophy text-warning"></i>
                            Top sách được mượn
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportTopBooks()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="top-items-list" id="topBooksList">
                        </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title">
                            <i class="fas fa-medal text-success"></i>
                            Top độc giả tích cực
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportTopReaders()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="top-items-list" id="topReadersList">
                        </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title">
                            <i class="fas fa-exclamation-circle text-danger"></i>
                            Phân tích quá hạn
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportOverdueAnalysis()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <canvas id="overdueAnalysisChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="report-table">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h5 class="mb-0">
                            <i class="fas fa-table text-primary"></i>
                            Báo cáo chi tiết
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm active" onclick="showDetailedReport('summary', this)">
                                Tổng quan
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showDetailedReport('daily', this)">
                                Theo ngày
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showDetailedReport('books', this)">
                                Theo sách
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showDetailedReport('readers', this)">
                                Theo độc giả
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showDetailedReport('fines', this)">
                                Phí phạt
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead id="reportTableHeader">
                                </thead>
                            <tbody id="reportTableBody">
                                </tbody>
                        </table>
                    </div>

                    <nav aria-label="Report pagination" class="p-3">
                        <ul class="pagination justify-content-center mb-0" id="reportPagination">
                            </ul>
                    </nav>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title">
                            <i class="fas fa-analytics text-info"></i>
                            Phân tích nâng cao
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-outline-info btn-sm" onclick="showPredictiveAnalysis()">
                                <i class="fas fa-crystal-ball"></i> Dự đoán
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showSeasonalAnalysis()">
                                <i class="fas fa-calendar-alt"></i> Theo mùa
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showCorrelationAnalysis()">
                                <i class="fas fa-project-diagram"></i> Tương quan
                            </button>
                        </div>
                    </div>

                    <div id="advancedAnalyticsContent">
                        <div class="row">
                            <div class="col-lg-8">
                                <canvas id="advancedChart" height="100"></canvas>
                            </div>
                            <div class="col-lg-4">
                                <div id="analyticsInsights">
                                    <h6>Thông tin chi tiết</h6>
                                    <div class="alert alert-info">
                                        <i class="fas fa-lightbulb"></i>
                                        Chọn một loại phân tích để xem thông tin chi tiết.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-download"></i> Xuất báo cáo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Định dạng xuất:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="exportExcel" value="excel" checked>
                            <label class="form-check-label" for="exportExcel">
                                <i class="fas fa-file-excel text-success"></i> Excel (.xlsx)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="exportPDF" value="pdf">
                            <label class="form-check-label" for="exportPDF">
                                <i class="fas fa-file-pdf text-danger"></i> PDF (.pdf)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="exportCSV" value="csv">
                            <label class="form-check-label" for="exportCSV">
                                <i class="fas fa-file-csv text-info"></i> CSV (.csv)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nội dung báo cáo:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">
                                Bao gồm biểu đồ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeDetails" checked>
                            <label class="form-check-label" for="includeDetails">
                                Bao gồm dữ liệu chi tiết
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">
                                Bao gồm tóm tắt
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tên file:</label>
                        <input type="text" class="form-control" id="exportFileName"
                               placeholder="bao-cao-thu-vien">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-primary" onclick="processExport()">
                        <i class="fas fa-download"></i> Xuất báo cáo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clock"></i> Lập lịch báo cáo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tần suất:</label>
                        <select class="form-select" id="scheduleFrequency">
                            <option value="daily">Hàng ngày</option>
                            <option value="weekly">Hàng tuần</option>
                            <option value="monthly">Hàng tháng</option>
                            <option value="quarterly">Hàng quý</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Thời gian gửi:</label>
                        <input type="time" class="form-control" id="scheduleTime" value="08:00">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email nhận báo cáo:</label>
                        <textarea class="form-control" id="scheduleEmails" rows="3"
                                placeholder="admin@school.edu.vn&#10;principal@school.edu.vn"></textarea>
                        <small class="form-text text-muted">Mỗi email một dòng</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Loại báo cáo:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleSummary" checked>
                            <label class="form-check-label" for="scheduleSummary">
                                Báo cáo tổng quan
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleOverdue">
                            <label class="form-check-label" for="scheduleOverdue">
                                Báo cáo sách quá hạn
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleActivity">
                            <label class="form-check-label" for="scheduleActivity">
                                Báo cáo hoạt động
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                        <i class="fas fa-save"></i> Lưu lịch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3">Đang tạo báo cáo...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Global variables
        let charts = {};
        let currentReportType = 'summary'; // Default detailed report type
        let currentPeriod = 'month'; // Default period
        let reportData = {}; // Stores all generated report data for current period

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure dataManager is ready before proceeding
            if (typeof window.dataManager === 'undefined') {
                setTimeout(initializeReportsPage, 100); // Retry after a short delay
            } else {
                initializeReportsPage();
            }
            window.app.checkAuthenticationStatus(); // Check authentication
            window.app.setCurrentUser(); // Set current user
        });

        // Initialize reports page
        function initializeReportsPage() {
            // Set default date range
            const today = new Date();
            let firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('fromDate').value = window.app.formatDate(firstDayOfMonth, 'yyyy-mm-dd');
            document.getElementById('toDate').value = window.app.formatDate(today, 'yyyy-mm-dd');

            // Initialize period selector
            document.getElementById('periodSelect').addEventListener('change', function() {
                const customRanges = document.querySelectorAll('#customDateRange, #customDateRange2');
                if (this.value === 'custom') {
                    customRanges.forEach(el => el.style.display = 'block');
                } else {
                    customRanges.forEach(el => el.style.display = 'none');
                    // Set dates based on predefined period
                    setPredefinedDates(this.value);
                }
                updateReports(); // Load data based on new period
            });

            // Set predefined dates on initial load
            setPredefinedDates(document.getElementById('periodSelect').value);

            // Add event listeners for custom date range inputs
            document.getElementById('fromDate').addEventListener('change', updateReports);
            document.getElementById('toDate').addEventListener('change', updateReports);

            // Initialize chart radio buttons
            document.querySelectorAll('input[name="trendChart"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateBorrowReturnChart(this.id);
                });
            });

            loadReportData(); // Initial load of all report data
        }

        // Set dates for predefined periods
        function setPredefinedDates(period) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();

            switch (period) {
                case 'today':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    toDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);
                    break;
                case 'week':
                    const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
                    fromDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - dayOfWeek);
                    toDate = new Date(fromDate);
                    toDate.setDate(toDate.getDate() + 6);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Last day of current month
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'quarter':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    toDate = new Date(today.getFullYear(), currentQuarter * 3 + 3, 0);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = new Date(today.getFullYear(), 11, 31);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                // 'custom' case is handled by user input
            }

            if (period !== 'custom') {
                document.getElementById('fromDate').value = window.app.formatDate(fromDate, 'yyyy-mm-dd');
                document.getElementById('toDate').value = window.app.formatDate(toDate, 'yyyy-mm-dd');
            }
        }

        // Load report data
        function loadReportData() {
            window.app.showLoading('Đang tải dữ liệu báo cáo...');

            setTimeout(() => {
                const periodSelect = document.getElementById('periodSelect').value;
                let fromDateStr = document.getElementById('fromDate').value;
                let toDateStr = document.getElementById('toDate').value;

                // Ensure dates are valid for non-custom periods if they were changed
                if (periodSelect !== 'custom') {
                    setPredefinedDates(periodSelect); // Re-set to ensure correct dates
                    fromDateStr = document.getElementById('fromDate').value;
                    toDateStr = document.getElementById('toDate').value;
                }

                const fromDate = new Date(fromDateStr);
                const toDate = new Date(toDateStr);

                if (isNaN(fromDate.getTime()) || isNaN(toDate.getTime())) {
                    window.app.showNotification('Ngày không hợp lệ. Vui lòng kiểm tra lại.', 'error');
                    window.app.hideLoading();
                    return;
                }
                 if (fromDate > toDate) {
                    window.app.showNotification('Ngày "Từ" không thể sau ngày "Đến".', 'error');
                    window.app.hideLoading();
                    return;
                }

                // Generate report data using dataManager functions
                reportData = generateReportData(fromDate, toDate, periodSelect);

                updateAllCharts();
                updateQuickStats();
                updateTopLists();
                showDetailedReport(currentReportType, document.querySelector(`.btn-group .btn[onclick*="showDetailedReport('${currentReportType}')"]`));
                window.app.hideLoading();
            }, 1500);
        }

        // Generate report data (main function to orchestrate data collection)
        function generateReportData(fromDate, toDate, periodType) {
            const stats = window.dataManager.getStatistics(); // Overall stats
            const borrowReturnReport = window.dataManager.generateBorrowReport(fromDate, toDate, getGroupByKey(periodType));
            const bookReport = window.dataManager.generateBookReport(fromDate, toDate);
            const readerReport = window.dataManager.generateReaderReport(fromDate, toDate);
            const fineReport = window.dataManager.generateFineReport(fromDate, toDate);

            return {
                summary: {
                    totalBorrows: borrowReturnReport.summary.totalBorrows,
                    totalReturns: borrowReturnReport.summary.totalReturns,
                    overdueBooks: window.dataManager.getOverdueBooks().length, // Global overdue count
                    activeReaders: readerReport.summary.activeReaders,
                    totalFines: fineReport.summary.totalAmount, // Total fines issued in the period
                    renewalCount: window.dataManager.getAllRenewals().filter(r => new Date(r.renewalDate) >= fromDate && new Date(r.renewalDate) <= toDate).length // Renewals in period
                },
                trends: calculateTrends(borrowReturnReport.summary), // Needs comparison data
                borrowReturnData: processBorrowReturnChartData(borrowReturnReport),
                categoryData: processCategoryChartData(bookReport.categorySummary),
                classData: processClassChartData(readerReport.classSummary),
                monthlyData: processMonthlyComparisonData(fromDate, toDate),
                topBooks: bookReport.popularBooks,
                topReaders: readerReport.topReaders,
                overdueAnalysis: processOverdueAnalysisData(window.dataManager.getOverdueBooks()), // Global overdue analysis for specific ranges
                detailedReports: {
                    summary: createSummaryDetailedData(borrowReturnReport.summary, readerReport.summary, fineReport.summary),
                    daily: borrowReturnReport.data, // Daily data from borrow report
                    books: bookReport.popularBooks, // Simplified for detailed table
                    readers: readerReport.topReaders, // Simplified for detailed table
                    fines: fineReport.dailyFines // Daily fines
                }
            };
        }

        // Helper to convert period type to groupBy key for dataManager
        function getGroupByKey(periodType) {
            switch (periodType) {
                case 'today':
                case 'week':
                case 'custom': // If custom range is very short, daily might be best
                    return 'day';
                case 'month':
                    return 'day'; // Still group by day, but chart can aggregate monthly
                case 'quarter':
                case 'year':
                    return 'month';
                default:
                    return 'day';
            }
        }

        // Placeholder for calculating trends (requires comparing with previous periods)
        function calculateTrends(currentSummary) {
            // In a real app, you'd fetch data for the 'previous period'
            // For now, simulate some trends
            return {
                borrowTrend: 12, // Placeholder
                returnTrend: 8, // Placeholder
                overdueTrend: -5, // Placeholder
                readerTrend: 15, // Placeholder
                fineTrend: -10, // Placeholder
                renewalTrend: 0 // Placeholder
            };
        }

        function processBorrowReturnChartData(report) {
            const labels = report.data.map(item => window.app.formatDate(item.date));
            const borrows = report.data.map(item => item.borrows);
            const returns = report.data.map(item => item.returns);
            return {
                daily: { labels, borrows, returns }, // Using daily as the default
                weekly: { labels: ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'], borrows: [280, 320, 290, 310], returns: [260, 300, 280, 295] }, // Placeholder
                monthly: { labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'], borrows: [1200, 1100, 1300, 1250, 1400, 800, 600, 900, 1350, 1300, 1247, 1100], returns: [1150, 1080, 1280, 1200, 1350, 780, 580, 870, 1300, 1250, 1189, 1050] } // Placeholder
            };
        }

        function processCategoryChartData(categorySummary) {
            const sortedCategories = [...categorySummary].sort((a,b) => b.borrowsInPeriod - a.borrowsInPeriod).slice(0,8); // Top 8
            return {
                labels: sortedCategories.map(cat => cat.categoryName),
                values: sortedCategories.map(cat => cat.borrowsInPeriod)
            };
        }

        function processClassChartData(classSummary) {
            const sortedClasses = [...classSummary].sort((a,b) => b.totalBorrows - a.totalBorrows).slice(0,9); // Top 9
            return {
                labels: sortedClasses.map(cls => cls.className),
                values: sortedClasses.map(cls => cls.totalBorrows)
            };
        }

        function processMonthlyComparisonData(fromDate, toDate) {
            // This would fetch actual monthly data from dataManager for current and last year
            // For now, using mock data for comparison as dataManager.generateBorrowReport only handles one period
            return {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                currentYear: [1200, 1100, 1300, 1250, 1400, 800, 600, 900, 1350, 1300, 1247, 1100],
                lastYear: [1100, 1050, 1200, 1180, 1250, 750, 550, 850, 1200, 1150, 1100, 1000]
            };
        }

        function processOverdueAnalysisData(overdueBooks) {
            const range1_3 = overdueBooks.filter(b => b.overdueDays >=1 && b.overdueDays <= 3).length;
            const range4_7 = overdueBooks.filter(b => b.overdueDays >=4 && b.overdueDays <= 7).length;
            const range8_14 = overdueBooks.filter(b => b.overdueDays >=8 && b.overdueDays <= 14).length;
            const range14_plus = overdueBooks.filter(b => b.overdueDays > 14).length;

            return {
                labels: ['1-3 ngày', '4-7 ngày', '8-14 ngày', '> 14 ngày'],
                values: [range1_3, range4_7, range8_14, range14_plus]
            };
        }

        // Create summary detailed data from report summaries
        function createSummaryDetailedData(borrowReturnSummary, readerSummary, fineSummary) {
            return [
                { metric: 'Tổng lượt mượn', value: borrowReturnSummary.totalBorrows.toLocaleString(), change: '+12%', target: '1,200', achieved: '103.9%' },
                { metric: 'Tổng lượt trả', value: borrowReturnSummary.totalReturns.toLocaleString(), change: '+8%', target: '1,150', achieved: '103.4%' },
                { metric: 'Sách quá hạn', value: window.dataManager.getOverdueBooks().length.toLocaleString(), change: '-5%', target: '< 60', achieved: '96.7%' },
                { metric: 'Độc giả hoạt động', value: readerSummary.activeReaders.toLocaleString(), change: '+15%', target: '300', achieved: '114.0%' },
                { metric: 'Tổng phí phạt', value: window.app.formatCurrency(fineSummary.totalAmount), change: '-10%', target: '< 1,500,000đ', achieved: '77.3%' },
                { metric: 'Lượt gia hạn', value: window.dataManager.getAllRenewals().length.toLocaleString(), change: '0%', target: '150', achieved: '104.0%' } // Overall renewals
            ];
        }


        // Update all charts
        function updateAllCharts() {
            updateBorrowReturnChart('daily'); // Default to daily trend
            updateCategoryChart();
            updateClassActivityChart();
            updateMonthlyComparisonChart();
            updateOverdueAnalysisChart();
        }

        // Update quick stats
        function updateQuickStats() {
            const data = reportData.summary;
            const trends = reportData.trends;

            document.getElementById('totalBorrows').textContent = data.totalBorrows.toLocaleString();
            document.getElementById('totalReturns').textContent = data.totalReturns.toLocaleString();
            document.getElementById('overdueBooks').textContent = data.overdueBooks.toLocaleString();
            document.getElementById('activeReaders').textContent = data.activeReaders.toLocaleString();
            document.getElementById('totalFines').textContent = data.totalFines; // Already formatted
            document.getElementById('renewalCount').textContent = data.renewalCount.toLocaleString();

            // Update trends
            updateTrendIndicator('borrowTrend', trends.borrowTrend);
            updateTrendIndicator('returnTrend', trends.returnTrend);
            updateTrendIndicator('overdueTrend', trends.overdueTrend);
            updateTrendIndicator('readerTrend', trends.readerTrend);
            updateTrendIndicator('fineTrend', trends.fineTrend);
            updateTrendIndicator('renewalTrend', trends.renewalTrend);
        }

        // Update trend indicator
        function updateTrendIndicator(elementId, value) {
            const element = document.getElementById(elementId);
            let icon, text, className;

            if (value > 0) {
                icon = 'fas fa-arrow-up';
                text = `+${value}% so với kỳ trước`;
                className = 'trend-up';
            } else if (value < 0) {
                icon = 'fas fa-arrow-down';
                text = `${value}% so với kỳ trước`;
                className = 'trend-down';
            } else {
                icon = 'fas fa-minus';
                text = 'Không đổi';
                className = 'trend-stable';
            }

            element.innerHTML = `<i class="${icon}"></i> ${text}`;
            element.className = `trend-indicator ${className}`;
        }

        // Update borrow/return chart
        function updateBorrowReturnChart(period) {
            const ctx = document.getElementById('borrowReturnChart').getContext('2d');

            if (charts.borrowReturn) {
                charts.borrowReturn.destroy();
            }

            const data = reportData.borrowReturnData[period];
            if (!data) { // Fallback if data for period is not available
                console.warn(`Data for borrowReturnChart period "${period}" is not available.`);
                return;
            }

            charts.borrowReturn = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Lượt mượn',
                        data: data.borrows,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Lượt trả',
                        data: data.returns,
                        borderColor: '#38ef7d',
                        backgroundColor: 'rgba(56, 239, 125, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: period === 'daily' ? 'Ngày' : period === 'weekly' ? 'Tuần' : 'Tháng'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Số lượng'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Update category chart
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (charts.category) {
                charts.category.destroy();
            }

            const data = reportData.categoryData;
            if (!data || data.values.length === 0) {
                ctx.canvas.parentNode.innerHTML = `<div class="loading-chart"><p>Không có dữ liệu thể loại.</p></div>`;
                return;
            }

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            '#667eea',
                            '#38ef7d',
                            '#f093fb',
                            '#4facfe',
                            '#fa709a',
                            '#ffd200',
                            '#ff6b6b',
                            '#4ecdc4'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update class activity chart
        function updateClassActivityChart() {
            const ctx = document.getElementById('classActivityChart').getContext('2d');

            if (charts.classActivity) {
                charts.classActivity.destroy();
            }

            const data = reportData.classData;
            if (!data || data.values.length === 0) {
                ctx.canvas.parentNode.innerHTML = `<div class="loading-chart"><p>Không có dữ liệu hoạt động theo lớp.</p></div>`;
                return;
            }

            charts.classActivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Số lượt mượn',
                        data: data.values,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Lớp'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Số lượt mượn'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update monthly comparison chart
        function updateMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart').getContext('2d');

            if (charts.monthlyComparison) {
                charts.monthlyComparison.destroy();
            }

            const data = reportData.monthlyData; // This is mock data
            if (!data || data.currentYear.length === 0) {
                ctx.canvas.parentNode.innerHTML = `<div class="loading-chart"><p>Không có dữ liệu so sánh theo tháng.</p></div>`;
                return;
            }

            charts.monthlyComparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Năm nay',
                        data: data.currentYear,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Năm trước',
                        data: data.lastYear,
                        borderColor: '#38ef7d',
                        backgroundColor: 'rgba(56, 239, 125, 0.1)',
                        tension: 0.4,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tháng'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Số lượt mượn'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update overdue analysis chart
        function updateOverdueAnalysisChart() {
            const ctx = document.getElementById('overdueAnalysisChart').getContext('2d');

            if (charts.overdueAnalysis) {
                charts.overdueAnalysis.destroy();
            }

            const data = reportData.overdueAnalysis;
             if (!data || data.values.length === 0) {
                ctx.canvas.parentNode.innerHTML = `<div class="loading-chart"><p>Không có dữ liệu phân tích quá hạn.</p></div>`;
                return;
            }


            charts.overdueAnalysis = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Số sách',
                        data: data.values,
                        backgroundColor: [
                            '#ffd200',
                            '#f093fb',
                            '#fa709a',
                            '#ff6b6b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Số ngày quá hạn'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Số sách'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update top lists
        function updateTopLists() {
            updateTopBooks();
            updateTopReaders();
        }

        // Update top books
        function updateTopBooks() {
            const container = document.getElementById('topBooksList');
            const books = reportData.topBooks;

            if (books.length === 0) {
                container.innerHTML = `<div class="text-center text-muted py-4"><p>Không có sách nào được mượn nhiều.</p></div>`;
                return;
            }

            let html = '';
            books.forEach((book, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.book.authorId)?.name || 'Không rõ';
                html += `
                    <div class="top-item">
                        <div class="d-flex align-items-center">
                            <div class="rank-badge ${rankClass} me-3">
                                ${index + 1}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${book.book.title}</h6>
                                <small class="text-muted">${authorName}</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-primary">${book.borrowCount}</strong>
                                <small class="text-muted d-block">lượt mượn</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update top readers
        function updateTopReaders() {
            const container = document.getElementById('topReadersList');
            const readers = reportData.topReaders;

            if (readers.length === 0) {
                container.innerHTML = `<div class="text-center text-muted py-4"><p>Không có độc giả tích cực.</p></div>`;
                return;
            }

            let html = '';
            readers.forEach((reader, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                html += `
                    <div class="top-item">
                        <div class="d-flex align-items-center">
                            <div class="rank-badge ${rankClass} me-3">
                                ${index + 1}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${reader.fullName}</h6>
                                <small class="text-muted">${reader.className}</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">${reader.totalBorrows}</strong>
                                <small class="text-muted d-block">cuốn sách</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show detailed report
        function showDetailedReport(type, buttonElement) {
            currentReportType = type;

            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonElement) {
                 buttonElement.classList.add('active');
            } else {
                // If buttonElement is not passed (e.g., on initial load), find it
                document.querySelector(`.btn-group .btn[onclick*="showDetailedReport('${type}')"]`).classList.add('active');
            }


            const header = document.getElementById('reportTableHeader');
            const body = document.getElementById('reportTableBody');
            const pagination = document.getElementById('reportPagination');
            pagination.innerHTML = ''; // Clear pagination for now

            window.app.showLoading('Đang tải báo cáo chi tiết...');

            setTimeout(() => {
                switch(type) {
                    case 'summary':
                        showSummaryReport(header, body);
                        break;
                    case 'daily':
                        showDailyReport(header, body);
                        break;
                    case 'books':
                        showBooksReport(header, body);
                        break;
                    case 'readers':
                        showReadersReport(header, body);
                        break;
                    case 'fines':
                        showFinesReport(header, body);
                        break;
                }
                window.app.hideLoading();
            }, 500);
        }

        // Show summary report
        function showSummaryReport(header, body) {
            header.innerHTML = `
                <tr>
                    <th>Chỉ số</th>
                    <th>Giá trị</th>
                    <th>So với kỳ trước</th>
                    <th>Mục tiêu</th>
                    <th>Đạt được</th>
                </tr>
            `;

            const summaryData = reportData.detailedReports.summary;

            let html = '';
            summaryData.forEach(item => {
                const changeClass = item.change.includes('+') ? 'text-success' :
                                  item.change.includes('-') ? 'text-danger' : 'text-muted';
                const achievedValue = parseFloat(item.achieved);
                const achievedClass = achievedValue >= 100 ? 'text-success' : (achievedValue >= 80 ? 'text-warning' : 'text-danger'); // Adjusted thresholds

                html += `
                    <tr>
                        <td><strong>${item.metric}</strong></td>
                        <td>${item.value}</td>
                        <td class="${changeClass}">
                            <i class="fas fa-${item.change.includes('+') ? 'arrow-up' :
                                              item.change.includes('-') ? 'arrow-down' : 'minus'}"></i>
                            ${item.change}
                        </td>
                        <td>${item.target}</td>
                        <td class="${achievedClass}"><strong>${item.achieved}</strong></td>
                    </tr>
                `;
            });

            body.innerHTML = html;
        }

        // Show daily report
        function showDailyReport(header, body) {
            header.innerHTML = `
                <tr>
                    <th>Ngày</th>
                    <th>Lượt mượn</th>
                    <th>Lượt trả</th>
                    <th>Gia hạn</th>
                    <th>Phí phạt phát sinh</th>
                    <th>Phí phạt đã thu</th>
                </tr>
            `;

            const dailyData = reportData.detailedReports.daily;
            if (dailyData.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Không có dữ liệu hàng ngày.</td></tr>`;
                return;
            }

            let html = '';
            dailyData.forEach(day => {
                const dailyFinesIssued = window.dataManager.getAllFines().filter(f => window.app.formatDate(f.issueDate, 'yyyy-mm-dd') === window.app.formatDate(day.date, 'yyyy-mm-dd')).reduce((sum,f) => sum + f.amount, 0);
                const dailyFinesPaid = window.dataManager.getAllFines().filter(f => f.paidDate && window.app.formatDate(f.paidDate, 'yyyy-mm-dd') === window.app.formatDate(day.date, 'yyyy-mm-dd')).reduce((sum,f) => sum + f.amount, 0);

                html += `
                    <tr>
                        <td>${window.app.formatDate(day.date)}</td>
                        <td><span class="badge bg-primary">${day.borrows}</span></td>
                        <td><span class="badge bg-success">${day.returns}</span></td>
                        <td><span class="badge bg-info">${day.renewals || 0}</span></td>
                        <td><strong>${window.app.formatCurrency(dailyFinesIssued)}</strong></td>
                        <td><strong class="text-success">${window.app.formatCurrency(dailyFinesPaid)}</strong></td>
                    </tr>
                `;
            });

            body.innerHTML = html;
        }

        // Show books report
        function showBooksReport(header, body) {
            header.innerHTML = `
                <tr>
                    <th>Mã sách</th>
                    <th>Tên sách</th>
                    <th>Tác giả</th>
                    <th>Thể loại</th>
                    <th>Tổng số</th>
                    <th>Có sẵn</th>
                    <th>Đang mượn</th>
                </tr>
            `;

            const booksData = window.dataManager.getAllBooks().map(book => {
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                return {
                    id: book.id,
                    title: book.title,
                    author: authorName,
                    category: categoryName,
                    totalCopies: book.totalCopies,
                    availableCopies: book.availableCopies,
                    borrowedCopies: book.borrowedCopies
                };
            }).sort((a,b) => b.borrowedCopies - a.borrowedCopies); // Sort by most borrowed

            if (booksData.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Không có dữ liệu sách.</td></tr>`;
                return;
            }

            let html = '';
            booksData.forEach(book => {
                html += `
                    <tr>
                        <td><code>${book.id}</code></td>
                        <td><strong>${book.title}</strong></td>
                        <td>${book.author}</td>
                        <td><span class="badge bg-secondary">${book.category}</span></td>
                        <td><span class="badge bg-primary">${book.totalCopies}</span></td>
                        <td><span class="badge bg-success">${book.availableCopies}</span></td>
                        <td><span class="badge bg-warning">${book.borrowedCopies}</span></td>
                    </tr>
                `;
            });

            body.innerHTML = html;
        }

        // Show readers report
        function showReadersReport(header, body) {
            header.innerHTML = `
                <tr>
                    <th>Mã thẻ</th>
                    <th>Họ tên</th>
                    <th>Lớp</th>
                    <th>Tổng mượn</th>
                    <th>Đang mượn</th>
                    <th>Quá hạn</th>
                    <th>Phí phạt</th>
                    <th>Trạng thái</th>
                </tr>
            `;

            const readersData = window.dataManager.getAllReaders().map(reader => {
                const borrowedCount = window.dataManager.getBorrowRecords({ readerId: reader.id, status: 'borrowed' }).length;
                const overdueCount = window.dataManager.getOverdueBooks().filter(b => b.readerId === reader.id).length;
                const totalFines = window.dataManager.getFines({ readerId: reader.id, status: 'unpaid' }).reduce((sum, f) => sum + f.amount, 0);
                const status = getReaderReportStatus(reader); // Use a local helper for report status

                return {
                    id: reader.id,
                    fullName: reader.fullName,
                    className: reader.className,
                    totalBorrows: reader.totalBorrows,
                    currentBorrows: borrowedCount,
                    overdueBooks: overdueCount,
                    fines: totalFines,
                    statusText: status.text,
                    statusClass: status.class
                };
            }).sort((a,b) => b.totalBorrows - a.totalBorrows); // Sort by total borrows

            if (readersData.length === 0) {
                body.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Không có dữ liệu độc giả.</td></tr>`;
                return;
            }

            let html = '';
            readersData.forEach(reader => {
                html += `
                    <tr>
                        <td><code>${reader.id}</code></td>
                        <td><strong>${reader.fullName}</strong></td>
                        <td>${reader.className}</td>
                        <td><span class="badge bg-info">${reader.totalBorrows}</span></td>
                        <td><span class="badge bg-warning">${reader.currentBorrows}</span></td>
                        <td><span class="badge bg-danger">${reader.overdueBooks}</span></td>
                        <td><strong>${window.app.formatCurrency(reader.fines)}</strong></td>
                        <td><span class="badge ${reader.statusClass}">${reader.statusText}</span></td>
                    </tr>
                `;
            });

            body.innerHTML = html;
        }

        // Helper for reader report status
        function getReaderReportStatus(reader) {
            const today = new Date();
            const expiryDate = new Date(reader.hanThe);
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            const hasUnpaidFines = window.dataManager.getFines({ readerId: reader.id, status: 'unpaid' }).length > 0;
            const hasOverdueBooks = window.dataManager.getOverdueBooks().filter(b => b.readerId === reader.id).length > 0;

            if (reader.status === 'suspended') {
                return { class: 'bg-secondary', text: 'Tạm khóa' };
            } else if (daysUntilExpiry < 0) {
                return { class: 'bg-danger', text: 'Hết hạn' };
            } else if (hasUnpaidFines || hasOverdueBooks) {
                return { class: 'bg-warning', text: 'Cảnh báo' }; // Reader with fines or overdue books
            } else if (daysUntilExpiry <= 30) {
                return { class: 'bg-info', text: 'Sắp hết hạn' };
            } else {
                return { class: 'bg-success', text: 'Hoạt động' };
            }
        }


        // Show fines report
        function showFinesReport(header, body) {
            header.innerHTML = `
                <tr>
                    <th>Ngày phát sinh</th>
                    <th>Độc giả</th>
                    <th>Sách</th>
                    <th>Ngày quá hạn</th>
                    <th>Số ngày</th>
                    <th>Phí phạt</th>
                    <th>Trạng thái</th>
                </tr>
            `;

            const finesData = window.dataManager.getAllFines().map(fine => {
                const reader = window.dataManager.getReader(fine.readerId);
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === fine.borrowRecordId);
                const book = borrowRecord ? window.dataManager.getBook(borrowRecord.bookId) : null;
                const overdueDays = borrowRecord ? window.dataManager.calculateOverdueDays(borrowRecord.dueDate) : 0; // Use dataManager's function
                const statusClass = fine.status === 'paid' ? 'bg-success' : 'bg-warning';
                const statusText = fine.status === 'paid' ? 'Đã thu' : 'Chưa thu';

                return {
                    issueDate: fine.issueDate,
                    readerName: reader ? reader.fullName : 'Không tìm thấy',
                    readerId: fine.readerId,
                    bookTitle: book ? book.title : 'Không tìm thấy',
                    bookId: fine.bookId,
                    overdueDate: borrowRecord ? borrowRecord.dueDate : null,
                    overdueDays: overdueDays,
                    amount: fine.amount,
                    statusClass: statusClass,
                    statusText: statusText
                };
            }).sort((a,b) => b.issueDate - a.issueDate); // Sort by issue date

            if (finesData.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Không có dữ liệu phí phạt.</td></tr>`;
                return;
            }

            let html = '';
            finesData.forEach(fine => {
                html += `
                    <tr>
                        <td>${window.app.formatDate(fine.issueDate)}</td>
                        <td>
                            <strong>${fine.readerName}</strong><br>
                            <small class="text-muted">${fine.readerId}</small>
                        </td>
                        <td>
                            <strong>${fine.bookTitle}</strong><br>
                            <small class="text-muted">${fine.bookId}</small>
                        </td>
                        <td>${fine.overdueDate ? window.app.formatDate(fine.overdueDate) : '-'}</td>
                        <td><span class="badge bg-danger">${fine.overdueDays}</span></td>
                        <td><strong>${window.app.formatCurrency(fine.amount)}</strong></td>
                        <td><span class="badge ${fine.statusClass}">${fine.statusText}</span></td>
                    </tr>
                `;
            });

            body.innerHTML = html;
        }

        // Update reports based on period
        function updateReports() {
            currentPeriod = document.getElementById('periodSelect').value;
            loadReportData();
        }

        // Update comparison (placeholder)
        function updateComparison() {
            const compareType = document.getElementById('compareSelect').value;
            window.app.showNotification(`Tính năng so sánh (${compareType}) đang phát triển.`, 'info');
            // updateAllCharts(); // Re-render charts with comparison logic
        }

        // Advanced analytics functions (simulated data)
        function showPredictiveAnalysis() {
            const ctx = document.getElementById('advancedChart').getContext('2d');

            if (charts.advanced) {
                charts.advanced.destroy();
            }

            // Generate predictive data (simulated)
            const predictiveData = generatePredictiveData();

            charts.advanced = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: predictiveData.labels,
                    datasets: [{
                        label: 'Dữ liệu thực tế',
                        data: predictiveData.actual,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Dự đoán',
                        data: predictiveData.predicted,
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Update insights
            document.getElementById('analyticsInsights').innerHTML = `
                <h6>Dự đoán xu hướng</h6>
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Thông tin chi tiết:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Dự kiến lượt mượn sách sẽ tăng 15% trong tháng tới</li>
                        <li>Thể loại "Khoa học" có xu hướng tăng mạnh</li>
                        <li>Cần chuẩn bị thêm sách cho kỳ thi cuối năm</li>
                        <li>Độc giả lớp 12 sẽ giảm hoạt động từ tháng 4</li>
                    </ul>
                </div>
            `;
        }

        function showSeasonalAnalysis() {
            const ctx = document.getElementById('advancedChart').getContext('2d');

            if (charts.advanced) {
                charts.advanced.destroy();
            }

            const seasonalData = generateSeasonalData(); // Simulated

            charts.advanced = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: seasonalData.labels,
                    datasets: [{
                        label: 'Mùa xuân',
                        data: seasonalData.spring,
                        borderColor: '#38ef7d',
                        backgroundColor: 'rgba(56, 239, 125, 0.2)'
                    }, {
                        label: 'Mùa hè',
                        data: seasonalData.summer,
                        borderColor: '#ffd200',
                        backgroundColor: 'rgba(255, 210, 0, 0.2)'
                    }, {
                        label: 'Mùa thu',
                        data: seasonalData.autumn,
                        borderColor: '#fa709a',
                        backgroundColor: 'rgba(250, 112, 154, 0.2)'
                    }, {
                        label: 'Mùa đông',
                        data: seasonalData.winter,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });

            document.getElementById('analyticsInsights').innerHTML = `
                <h6>Phân tích theo mùa</h6>
                <div class="alert alert-success">
                    <i class="fas fa-calendar-alt"></i>
                    <strong>Nhận xét:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Mùa thu có hoạt động mượn sách cao nhất</li>
                        <li>Mùa hè giảm 40% so với các mùa khác</li>
                        <li>Thể loại "Giáo khoa" tăng mạnh vào đầu năm học</li>
                        <li>Sách "Tham khảo" được ưa chuộng vào mùa thi</li>
                    </ul>
                </div>
            `;
        }

        function showCorrelationAnalysis() {
            const ctx = document.getElementById('advancedChart').getContext('2d');

            if (charts.advanced) {
                charts.advanced.destroy();
            }

            const correlationData = generateCorrelationData(); // Simulated

            charts.advanced = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Mối tương quan',
                        data: correlationData.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Số lượng sách trong thư viện'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Lượt mượn trung bình/tháng'
                            }
                        }
                    }
                }
            });

            document.getElementById('analyticsInsights').innerHTML = `
                <h6>Phân tích tương quan</h6>
                <div class="alert alert-warning">
                    <i class="fas fa-project-diagram"></i>
                    <strong>Kết quả phân tích:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Hệ số tương quan: 0.78 (mạnh)</li>
                        <li>Tăng số lượng sách có thể tăng lượt mượn</li>
                        <li>Thể loại "Văn học" có tương quan cao nhất</li>
                        <li>Cần đầu tư thêm sách cho các thể loại phổ biến</li>
                    </ul>
                </div>
            `;
        }

        // Export functions
        function exportAllReports() {
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }

        function exportTopBooks() {
            const data = reportData.topBooks;
            const csv = generateTopBooksCSV(data);
            window.app.downloadFile(csv, 'top-sach-duoc-muon.csv', 'text/csv;charset=utf-8;');
            window.app.showNotification('Xuất danh sách sách phổ biến thành công!', 'success');
        }

        function exportTopReaders() {
            const data = reportData.topReaders;
            const csv = generateTopReadersCSV(data);
            window.app.downloadFile(csv, 'top-doc-gia-tich-cuc.csv', 'text/csv;charset=utf-8;');
            window.app.showNotification('Xuất danh sách độc giả tích cực thành công!', 'success');
        }

        function exportOverdueAnalysis() {
            const data = reportData.overdueAnalysis;
            const csv = generateOverdueAnalysisCSV(data);
            window.app.downloadFile(csv, 'phan-tich-qua-han.csv', 'text/csv;charset=utf-8;');
            window.app.showNotification('Xuất phân tích quá hạn thành công!', 'success');
        }

        function processExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            const includeDetails = document.getElementById('includeDetails').checked;
            const includeSummary = document.getElementById('includeSummary').checked;
            const fileName = document.getElementById('exportFileName').value || 'bao-cao-thu-vien';

            window.app.showLoading('Đang xuất báo cáo...');

            setTimeout(() => {
                switch(format) {
                    case 'excel':
                        exportToExcel(fileName, includeCharts, includeDetails, includeSummary);
                        break;
                    case 'pdf':
                        exportToPDF(fileName, includeCharts, includeDetails, includeSummary);
                        break;
                    case 'csv':
                        exportFullReportToCSV(fileName, includeSummary, includeDetails);
                        break;
                }

                window.app.hideLoading();

                const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
                modal.hide();

                window.app.showNotification('Xuất báo cáo thành công!', 'success');
            }, 2000);
        }

        // Print report
        function printReport() {
            const printContent = generatePrintableReport();
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Báo cáo thống kê thư viện</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
                        .stat-item { border: 1px solid #ddd; padding: 15px; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.print();
        }

        // Schedule report
        function scheduleReport() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        }

        function saveSchedule() {
            const frequency = document.getElementById('scheduleFrequency').value;
            const time = document.getElementById('scheduleTime').value;
            const emails = document.getElementById('scheduleEmails').value;
            const reportTypes = [];

            if (document.getElementById('scheduleSummary').checked) reportTypes.push('summary');
            if (document.getElementById('scheduleOverdue').checked) reportTypes.push('overdue');
            if (document.getElementById('scheduleActivity').checked) reportTypes.push('activity');

            window.app.showLoading('Đang lưu lịch báo cáo...');

            setTimeout(() => {
                // Simulate saving schedule to backend/localStorage
                const scheduleData = {
                    frequency,
                    time,
                    emails: emails.split('\n').filter(email => email.trim()),
                    reportTypes,
                    createdBy: window.app.currentUser?.username || 'Admin',
                    createdAt: new Date().toISOString()
                };

                console.log('Schedule saved:', scheduleData);
                window.app.logActivity('schedule_report', 'Lập lịch báo cáo', scheduleData); // Log activity

                window.app.hideLoading();

                const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                modal.hide();

                window.app.showNotification('Lưu lịch báo cáo thành công!', 'success');
            }, 1000);
        }

        // Data generation functions (these should now use dataManager)
        function generateBorrowReturnData(fromDate, toDate, groupBy) {
            return window.dataManager.generateBorrowReport(fromDate, toDate, groupBy);
        }

        function generateCategoryData(fromDate, toDate) {
            const bookReport = window.dataManager.generateBookReport(fromDate, toDate);
            return processCategoryChartData(bookReport.categorySummary);
        }

        function generateClassData(fromDate, toDate) {
            const readerReport = window.dataManager.generateReaderReport(fromDate, toDate);
            return processClassChartData(readerReport.classSummary);
        }

        function generateMonthlyData(fromDate, toDate) {
            // This needs actual monthly data for comparison, currently mocked.
            // In a full implementation, you'd call dataManager.generateBorrowReport for two periods (current year, last year)
            // Example:
            // const currentYearReport = window.dataManager.generateBorrowReport(new Date(fromDate.getFullYear(), 0, 1), toDate, 'month');
            // const lastYearReport = window.dataManager.generateBorrowReport(new Date(fromDate.getFullYear() - 1, 0, 1), new Date(toDate.getFullYear() - 1, toDate.getMonth(), toDate.getDate()), 'month');
            // Then extract labels and sums for currentYear and lastYear.
            return {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                currentYear: [1200, 1100, 1300, 1250, 1400, 800, 600, 900, 1350, 1300, 1247, 1100],
                lastYear: [1100, 1050, 1200, 1180, 1250, 750, 550, 850, 1200, 1150, 1100, 1000]
            };
        }

        function generateTopBooks(fromDate, toDate) {
            const bookReport = window.dataManager.generateBookReport(fromDate, toDate);
            return bookReport.popularBooks; // This already contains book objects with borrowCount
        }

        function generateTopReaders(fromDate, toDate) {
            const readerReport = window.dataManager.generateReaderReport(fromDate, toDate);
            return readerReport.topReaders;
        }

        function generateOverdueAnalysis(fromDate, toDate) {
            // This is using overall overdue data. If you need it specific to the period, filter here.
            return processOverdueAnalysisData(window.dataManager.getOverdueBooks());
        }

        function generateDailyReportData(fromDate, toDate) {
            const borrowReport = window.dataManager.generateBorrowReport(fromDate, toDate, 'day');
            // Enrich with fines data
            const dailyData = borrowReport.data.map(day => {
                const dayDateStr = window.app.formatDate(day.date, 'yyyy-mm-dd');
                const dailyFinesIssued = window.dataManager.getAllFines().filter(f => window.app.formatDate(f.issueDate, 'yyyy-mm-dd') === dayDateStr).reduce((sum,f) => sum + f.amount, 0);
                const dailyRenewals = window.dataManager.getAllRenewals().filter(r => window.app.formatDate(r.renewalDate, 'yyyy-mm-dd') === dayDateStr).length;

                return {
                    date: day.date,
                    borrows: day.borrows,
                    returns: day.returns,
                    renewals: dailyRenewals, // New
                    newOverdue: 0, // Not easily calculated here without specific daily overdue events
                    fines: dailyFinesIssued
                };
            });
            return dailyData;
        }

        function generateBooksReportData(fromDate, toDate) {
            const bookReport = window.dataManager.generateBookReport(fromDate, toDate);
            return window.dataManager.getAllBooks().map(book => {
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                return {
                    code: book.id,
                    title: book.title,
                    author: authorName,
                    category: categoryName,
                    borrowCount: bookReport.popularBooks.find(pb => pb.book.id === book.id)?.borrowCount || 0,
                    currentBorrows: book.borrowedCopies,
                    utilization: book.totalCopies > 0 ? ((book.borrowedCopies / book.totalCopies) * 100).toFixed(0) : 0
                };
            }).sort((a,b) => b.borrowCount - a.borrowCount);
        }

        function generateReadersReportData(fromDate, toDate) {
            const readerReport = window.dataManager.generateReaderReport(fromDate, toDate);
             return readerReport.topReaders.map(reader => {
                const borrowedCount = window.dataManager.getBorrowRecords({ readerId: reader.id, status: 'borrowed' }).length;
                const overdueCount = window.dataManager.getOverdueBooks().filter(b => b.readerId === reader.id).length;
                const totalFines = window.dataManager.getFines({ readerId: reader.id, status: 'unpaid' }).reduce((sum, f) => sum + f.amount, 0);
                const status = getReaderReportStatus(reader);

                return {
                    cardId: reader.id,
                    name: reader.fullName,
                    class: reader.className,
                    totalBorrows: reader.totalBorrows, // total books ever borrowed
                    currentBorrows: borrowedCount,
                    overdueBooks: overdueCount,
                    fines: totalFines,
                    status: status.text
                };
            });
        }

        function generateFinesReportData(fromDate, toDate) {
            const fineReport = window.dataManager.generateFineReport(fromDate, toDate);
            return fineReport.dailyFines.map(dailyFine => {
                // This daily fine data is summarized. For a detailed list, we need to iterate all fines
                return {
                    date: dailyFine.date,
                    finesIssued: dailyFine.finesIssued,
                    amountIssued: dailyFine.amountIssued,
                    finesPaid: dailyFine.finesPaid,
                    amountPaid: dailyFine.amountPaid
                };
            });
        }

        // Simulated advanced analytics data
        function generatePredictiveData() {
            const labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
            const actual = [1200, 1100, 1300, 1250, 1400, 800, 600, 900, 1350, 1300, 1247, null];
            const predicted = [null, null, null, null, null, null, null, null, null, null, 1247, 1350, 1420, 1380, 1450];

            return { labels: [...labels, 'T1 (2025)', 'T2 (2025)', 'T3 (2025)'], actual, predicted };
        }

        function generateSeasonalData() {
            return {
                labels: ['Văn học', 'Khoa học', 'Lịch sử', 'Địa lý', 'Toán học', 'Ngoại ngữ'],
                spring: [85, 70, 60, 55, 80, 65],
                summer: [45, 30, 25, 20, 35, 40],
                autumn: [95, 85, 75, 70, 90, 75],
                winter: [75, 65, 55, 50, 70, 60]
            };
        }

        function generateCorrelationData() {
            const data = [];
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * 100 + 50; // Số lượng sách
                const y = x * 0.8 + Math.random() * 20; // Lượt mượn (có tương quan)
                data.push({ x, y });
            }
            return { data };
        }

        // CSV generation functions
        function generateTopBooksCSV(data) {
            let csv = 'STT,Tên sách,Tác giả,Số lượt mượn\n';
            data.forEach((item, index) => {
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === item.book.authorId)?.name || 'Không rõ';
                csv += `${index + 1},"${item.book.title}","${authorName}",${item.borrowCount}\n`;
            });
            return csv;
        }

        function generateTopReadersCSV(data) {
            let csv = 'STT,Họ tên,Lớp,Số sách đã mượn\n';
            data.forEach((reader, index) => {
                csv += `${index + 1},"${reader.fullName}","${reader.className}",${reader.totalBorrows}\n`;
            });
            return csv;
        }

        function generateOverdueAnalysisCSV(data) {
            let csv = 'Khoảng thời gian,Số sách\n';
            data.labels.forEach((label, index) => {
                csv += `"${label}",${data.values[index]}\n`;
            });
            return csv;
        }

        // Export functions
        function exportToExcel(fileName, includeCharts, includeDetails, includeSummary) {
            // Simulate Excel export (for a real app, use SheetJS or a backend service)
            console.log('Exporting to Excel:', { fileName, includeCharts, includeDetails, includeSummary });
            window.app.showNotification('Tính năng xuất Excel đang được phát triển!', 'info');
            // For a quick demo, fallback to CSV
            exportFullReportToCSV(fileName, includeSummary, includeDetails);
        }

        function exportToPDF(fileName, includeCharts, includeDetails, includeSummary) {
            // Simulate PDF export (for a real app, use jsPDF, html2canvas, or a backend service)
            console.log('Exporting to PDF:', { fileName, includeCharts, includeDetails, includeSummary });
            window.app.showNotification('Tính năng xuất PDF đang được phát triển!', 'info');
            // For a quick demo, print
            printReport();
        }

        function exportFullReportToCSV(fileName, includeSummary, includeDetails) {
            let csv = `Báo cáo thống kê thư viện\n`;
            csv += `Ngày tạo: ${window.app.formatDate(new Date())}\n\n`;
            csv += `Khoảng thời gian: ${getPeriodText(document.getElementById('periodSelect').value)} (${window.app.formatDate(document.getElementById('fromDate').value)} - ${window.app.formatDate(document.getElementById('toDate').value)})\n\n`;

            if (includeSummary) {
                csv += 'TỔNG QUAN\n';
                csv += `Tổng lượt mượn,${reportData.summary.totalBorrows}\n`;
                csv += `Tổng lượt trả,${reportData.summary.totalReturns}\n`;
                csv += `Sách quá hạn,${reportData.summary.overdueBooks}\n`;
                csv += `Độc giả hoạt động,${reportData.summary.activeReaders}\n`;
                csv += `Tổng phí phạt,${reportData.summary.totalFines}\n`;
                csv += `Lượt gia hạn,${reportData.summary.renewalCount}\n\n`;
            }

            if (includeDetails) {
                // Detailed Daily Report
                csv += 'BÁO CÁO CHI TIẾT THEO NGÀY\n';
                csv += 'Ngày,Lượt mượn,Lượt trả,Gia hạn,Phí phạt phát sinh,Phí phạt đã thu\n';
                reportData.detailedReports.daily.forEach(day => {
                    const dailyFinesIssued = window.dataManager.getAllFines().filter(f => window.app.formatDate(f.issueDate, 'yyyy-mm-dd') === window.app.formatDate(day.date, 'yyyy-mm-dd')).reduce((sum,f) => sum + f.amount, 0);
                    const dailyFinesPaid = window.dataManager.getAllFines().filter(f => f.paidDate && window.app.formatDate(f.paidDate, 'yyyy-mm-dd') === window.app.formatDate(day.date, 'yyyy-mm-dd')).reduce((sum,f) => sum + f.amount, 0);
                    csv += `"${window.app.formatDate(day.date)}",${day.borrows},${day.returns},${day.renewals || 0},${dailyFinesIssued},${dailyFinesPaid}\n`;
                });
                csv += '\n';

                // Top Books
                csv += 'TOP SÁCH ĐƯỢC MƯỢN\n';
                csv += 'STT,Tên sách,Tác giả,Số lượt mượn\n';
                reportData.topBooks.forEach((item, index) => {
                    const authorName = window.dataManager.getAllAuthors().find(a => a.id === item.book.authorId)?.name || 'Không rõ';
                    csv += `${index + 1},"${item.book.title}","${authorName}",${item.borrowCount}\n`;
                });
                csv += '\n';

                // Top Readers
                csv += 'TOP ĐỘC GIẢ TÍCH CỰC\n';
                csv += 'STT,Họ tên,Lớp,Tổng số sách đã mượn\n';
                reportData.topReaders.forEach((reader, index) => {
                    csv += `${index + 1},"${reader.fullName}","${reader.className}",${reader.totalBorrows}\n`;
                });
                csv += '\n';

                // Overdue Analysis
                csv += 'PHÂN TÍCH QUÁ HẠN\n';
                csv += 'Khoảng thời gian,Số sách\n';
                reportData.overdueAnalysis.labels.forEach((label, index) => {
                    csv += `"${label}",${reportData.overdueAnalysis.values[index]}\n`;
                });
                csv += '\n';
            }

            window.app.downloadFile(csv, `${fileName}.csv`, 'text/csv;charset=utf-8;');
        }

        function generatePrintableReport() {
            const today = new Date();
            const period = document.getElementById('periodSelect').value;

            const summary = reportData.summary;
            const topBooks = reportData.topBooks;
            const topReaders = reportData.topReaders;

            return `
                <div class="header">
                    <h1>BÁO CÁO THỐNG KÊ THƯ VIỆN</h1>
                    <h3>${window.app.getSystemSettings().libraryName || 'Thư viện trường THPT ABC'}</h3>
                    <p>Kỳ báo cáo: ${getPeriodText(period)}</p>
                    <p>Ngày tạo: ${window.app.formatDate(today)}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <h3>${summary.totalBorrows.toLocaleString()}</h3>
                        <p>Tổng lượt mượn</p>
                    </div>
                    <div class="stat-item">
                        <h3>${summary.totalReturns.toLocaleString()}</h3>
                        <p>Tổng lượt trả</p>
                    </div>
                    <div class="stat-item">
                        <h3>${summary.overdueBooks.toLocaleString()}</h3>
                        <p>Sách quá hạn</p>
                    </div>
                    <div class="stat-item">
                        <h3>${summary.activeReaders.toLocaleString()}</h3>
                        <p>Độc giả hoạt động</p>
                    </div>
                    <div class="stat-item">
                        <h3>${summary.totalFines}</h3>
                        <p>Tổng phí phạt</p>
                    </div>
                    <div class="stat-item">
                        <h3>${summary.renewalCount.toLocaleString()}</h3>
                        <p>Lượt gia hạn</p>
                    </div>
                </div>

                <h2>Top sách được mượn nhiều nhất</h2>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên sách</th>
                            <th>Tác giả</th>
                            <th>Số lượt mượn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topBooks.length > 0 ? topBooks.map((item, index) => {
                            const authorName = window.dataManager.getAllAuthors().find(a => a.id === item.book.authorId)?.name || 'Không rõ';
                            return `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.book.title}</td>
                                    <td>${authorName}</td>
                                    <td>${item.borrowCount}</td>
                                </tr>
                            `;
                        }).join('') : `<tr><td colspan="4" style="text-align: center;">Không có dữ liệu.</td></tr>`}
                    </tbody>
                </table>

                <h2>Top độc giả tích cực nhất</h2>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Họ tên</th>
                            <th>Lớp</th>
                            <th>Số sách đã mượn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topReaders.length > 0 ? topReaders.map((reader, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${reader.fullName}</td>
                                <td>${reader.className}</td>
                                <td>${reader.totalBorrows}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="4" style="text-align: center;">Không có dữ liệu.</td></tr>`}
                    </tbody>
                </table>
            `;
        }

        // Utility functions (from app.js or specific to this page)
        function getPeriodText(period) {
            const periods = {
                'today': 'Hôm nay',
                'week': 'Tuần này',
                'month': 'Tháng này',
                'quarter': 'Quý này',
                'year': 'Năm này',
                'custom': 'Tùy chọn'
            };
            return periods[period] || 'Không xác định';
        }

        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                window.app.logout();
            }
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadReportData();
                window.app.showNotification('Dữ liệu báo cáo đã được làm mới tự động.', 'info', 2000);
            }
        }, 300000); // 5 minutes

        // Handle window resize for charts
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>
