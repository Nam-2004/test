<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sách - Hệ thống quản lý thư viện</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-custom {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            padding: 20px 0;
        }

        .page-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .search-filter-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .books-table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
            color: white;
        }

        .btn-success-custom {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
        }

        .btn-success-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
            color: white;
        }

        .btn-warning-custom {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
        }

        .btn-warning-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
            color: white;
        }

        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .table-custom thead {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
        }

        .table-custom thead th {
            border: none;
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-custom tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }

        .table-custom tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-borrowed {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-unavailable {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-popular {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #99d6ff;
        }

        .book-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-1px);
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .stats-row {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pagination-custom .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
            color: #3498db;
        }

        .pagination-custom .page-link:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-custom .page-item.active .page-link {
            background: #3498db;
            border-color: #3498db;
        }

        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-custom .modal-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .book-actions {
                justify-content: center;
            }

            .table-responsive {
                font-size: 0.9rem;
            }

            .btn-custom {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-book"></i>
                Quản lý sách
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="books.html">
                            <i class="fas fa-book"></i> Quản lý sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="readers.html">
                            <i class="fas fa-users"></i> Quản lý độc giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="borrow-return.html">
                            <i class="fas fa-exchange-alt"></i> Mượn/Trả sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="fas fa-chart-bar"></i> Báo cáo
                        </a>
                    </li>
                </ul>

                <div class="navbar-nav">
                    <span class="nav-link">
                        <i class="fas fa-user"></i>
                        <span id="currentUser">Admin</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">
                        <i class="fas fa-books text-primary"></i>
                        Quản lý sách
                    </h2>
                    <p class="text-muted mb-0">Quản lý toàn bộ sách trong thư viện</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success-custom btn-custom" onclick="showAddBookModal()">
                        <i class="fas fa-plus"></i> Thêm sách mới
                    </button>
                    <button class="btn btn-warning-custom btn-custom" onclick="exportBooks()">
                        <i class="fas fa-download"></i> Xuất Excel
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="row">
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <div class="stat-number" id="totalBooksCount">0</div>
                        <div class="stat-label">Tổng sách</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-success" id="availableBooksCount">0</div>
                        <div class="stat-label">Có thể mượn</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-warning" id="borrowedBooksCount">0</div>
                        <div class="stat-label">Đang mượn</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-info" id="categoriesCount">0</div>
                        <div class="stat-label">Danh mục</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="search-filter-card">
            <h5 class="mb-4">
                <i class="fas fa-search text-primary"></i>
                Tìm kiếm & Lọc sách
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tìm kiếm:</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="searchInput"
                               placeholder="Tên sách, tác giả, mã sách..."
                               onkeyup="handleSearch(event)">
                        <button class="btn btn-primary-custom" onclick="searchBooks()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Loại sách:</label>
                    <select class="form-select" id="categoryFilter" onchange="filterBooks()">
                        <option value="">Tất cả</option>
                        </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Trạng thái:</label>
                    <select class="form-select" id="statusFilter" onchange="filterBooks()">
                        <option value="">Tất cả</option>
                        <option value="available">Có thể mượn</option>
                        <option value="borrowed">Đang mượn</option>
                        <option value="reserved">Đang đặt trước</option>
                        <option value="unavailable">Không có sẵn (hết)</option>
                    </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Sắp xếp:</label>
                    <select class="form-select" id="sortBy" onchange="sortBooks()">
                        <option value="title">Tên sách</option>
                        <option value="authorId">Tác giả</option>
                        <option value="totalCopies">Số lượng</option>
                        <option value="id">Mã sách</option>
                    </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Hiển thị:</label>
                    <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage()">
                        <option value="10">10 sách</option>
                        <option value="25">25 sách</option>
                        <option value="50">50 sách</option>
                        <option value="100">100 sách</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Xóa bộ lọc
                    </button>
                    <button class="btn btn-outline-info" onclick="refreshBooks()">
                        <i class="fas fa-sync"></i> Làm mới
                    </button>
                </div>
            </div>
        </div>

        <div class="books-table-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">
                    <i class="fas fa-list text-success"></i>
                    Danh sách sách
                    <span class="badge bg-primary" id="filteredCount">0</span>
                </h5>

                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleView('table')" id="tableViewBtn">
                        <i class="fas fa-table"></i> Bảng
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleView('grid')" id="gridViewBtn">
                        <i class="fas fa-th"></i> Lưới
                    </button>
                </div>
            </div>

            <div id="tableView">
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th>Mã sách</th>
                                <th>Tên sách</th>
                                <th>Loại</th>
                                <th>Tác giả</th>
                                <th>Số lượng</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="booksTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="gridView" class="d-none">
                <div class="row" id="booksGridContainer">
                    </div>
            </div>

            <nav aria-label="Books pagination" class="mt-4">
                <ul class="pagination pagination-custom justify-content-center" id="booksPagination">
                    </ul>
            </nav>
        </div>
    </div>

    <div class="modal fade modal-custom" id="bookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookModalTitle">
                        <i class="fas fa-plus"></i> Thêm sách mới
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm" data-clear-on-close="true">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mã sách (ID) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookId" required placeholder="Ví dụ: B001">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="bookTitle" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Loại sách <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookCategory" required>
                                    <option value="">Chọn loại sách</option>
                                    </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tác giả <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookAuthor" required>
                                    <option value="">Chọn tác giả</option>
                                    </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Số lượng bản sao <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="bookQuantity" min="1" max="999" required value="1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Năm xuất bản</label>
                                <input type="number" class="form-control" id="bookYear" min="1900" max="2025" value="2023">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Trạng thái (Hệ thống tự cập nhật)</label>
                                <input type="text" class="form-control" id="bookStatus" value="available" readonly>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nhà xuất bản</label>
                                <select class="form-select" id="bookPublisher">
                                    <option value="">Chọn nhà xuất bản</option>
                                    </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vị trí (kệ)</label>
                                <input type="text" class="form-control" id="bookLocation" placeholder="VD: A1-01">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="bookDescription" rows="3" placeholder="Mô tả ngắn về nội dung sách..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="bookISBN" placeholder="VD: 978-1234567890">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveBook()">
                        <i class="fas fa-save"></i> Lưu sách
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="bookDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i> Chi tiết sách
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="bookDetailsContent">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning-custom" onclick="editBookFromDetails()">
                        <i class="fas fa-edit"></i> Chỉnh sửa
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Xác nhận xóa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa sách này không?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-warning"></i>
                        <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác!
                    </div>
                    <div id="deleteBookInfo" class="bg-light p-3 rounded">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteBook()">
                        <i class="fas fa-trash"></i> Xóa sách
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3">Đang xử lý...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Global variables
        let currentBooks = [];
        let filteredBooks = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentView = 'table';
        let editingBookId = null;
        let bookToDelete = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure dataManager is ready before proceeding
            if (typeof window.dataManager === 'undefined') {
                setTimeout(initializeBooksPage, 100); // Retry after a short delay
            } else {
                initializeBooksPage();
            }
            checkAuthentication();
            setCurrentUser(); // from app.js
        });

        // Check authentication
        function checkAuthentication() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return;
            }
        }

        // Set current user
        function setCurrentUser() {
            const username = sessionStorage.getItem('username') || 'Admin';
            document.getElementById('currentUser').textContent = username;
        }

        // Initialize books page
        function initializeBooksPage() {
            // Set default view
            document.getElementById('tableViewBtn').classList.add('active');

            // Load initial data
            loadBooks();
            populateFilterDropdowns();
        }

        // Populate category filter and modal dropdowns
        function populateFilterDropdowns() {
            const categories = window.dataManager.getAllCategories();
            const authors = window.dataManager.getAllAuthors();
            const publishers = window.dataManager.getAllPublishers();

            const categoryFilter = document.getElementById('categoryFilter');
            const bookCategorySelect = document.getElementById('bookCategory');
            const bookAuthorSelect = document.getElementById('bookAuthor');
            const bookPublisherSelect = document.getElementById('bookPublisher');

            // Clear previous options
            categoryFilter.innerHTML = '<option value="">Tất cả</option>';
            bookCategorySelect.innerHTML = '<option value="">Chọn loại sách</option>';
            bookAuthorSelect.innerHTML = '<option value="">Chọn tác giả</option>';
            bookPublisherSelect.innerHTML = '<option value="">Chọn nhà xuất bản</option>';


            categories.forEach(cat => {
                const option = `<option value="${cat.id}">${cat.name}</option>`;
                categoryFilter.innerHTML += option;
                bookCategorySelect.innerHTML += option;
            });
            authors.forEach(auth => {
                bookAuthorSelect.innerHTML += `<option value="${auth.id}">${auth.name}</option>`;
            });
            publishers.forEach(pub => {
                bookPublisherSelect.innerHTML += `<option value="${pub.id}">${pub.name}</option>`;
            });

            // Set current year for bookYear input
            document.getElementById('bookYear').value = new Date().getFullYear();
        }


        // Load books data
        function loadBooks() {
            window.app.showLoading('Đang tải dữ liệu sách...');

            // Simulate loading delay
            setTimeout(() => {
                currentBooks = window.dataManager.getAllBooks();
                filterBooks(); // Apply filters and search after loading all books

                updateBooksStatistics();
                // displayBooks() and updatePagination() are called inside filterBooks()
                window.app.hideLoading();
            }, 500);
        }

        // Update books statistics
        function updateBooksStatistics() {
            const stats = window.dataManager.getStatistics();
            document.getElementById('totalBooksCount').textContent = stats.books.titles; // Total unique book titles
            document.getElementById('availableBooksCount').textContent = stats.books.available;
            document.getElementById('borrowedBooksCount').textContent = stats.books.borrowed;
            document.getElementById('categoriesCount').textContent = window.dataManager.getAllCategories().length;
        }

        // Helper to get display status of a book
        function getBookDisplayStatus(book) {
            let statusText = '';
            let statusClass = '';

            // Update book availability data first, as it might change from borrow/return actions
            window.dataManager.updateBookAvailability(book.id);

            if (book.availableCopies > 0) {
                statusText = 'Có thể mượn';
                statusClass = 'status-available';
            } else if (book.borrowedCopies > 0) {
                statusText = 'Đang mượn';
                statusClass = 'status-borrowed';
            } else if (book.reservedCopies > 0) {
                statusText = 'Đang đặt trước';
                statusClass = 'status-borrowed'; // Using borrowed style for reserved
            }
            else {
                statusText = 'Không có sẵn';
                statusClass = 'status-unavailable';
            }
            return { text: statusText, class: statusClass, available: book.availableCopies, total: book.totalCopies };
        }


        // Display books
        function displayBooks() {
            if (currentView === 'table') {
                displayBooksTable();
            } else {
                displayBooksGrid();
            }

            document.getElementById('filteredCount').textContent = filteredBooks.length;
        }

        // Display books in table format
        function displayBooksTable() {
            const tbody = document.getElementById('booksTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const booksToShow = filteredBooks.slice(startIndex, endIndex);

            if (booksToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không tìm thấy sách nào</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            booksToShow.forEach(book => {
                const status = getBookDisplayStatus(book);
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';

                html += `
                    <tr>
                        <td><strong>${book.id}</strong></td>
                        <td>
                            <div class="fw-bold">${book.title}</div>
                            <small class="text-muted">ISBN: ${book.isbn || 'N/A'}</small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">${categoryName}</span>
                        </td>
                        <td>${authorName}</td>
                        <td>
                            <span class="badge bg-info">${status.available}/${book.totalCopies}</span>
                        </td>
                        <td>
                            <span class="status-badge ${status.class}">${status.text}</span>
                        </td>
                        <td>
                            <div class="book-actions">
                                <button class="btn-action btn-view" onclick="viewBookDetails('${book.id}')" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" onclick="editBook('${book.id}')" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteBook('${book.id}')" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Display books in grid format
        function displayBooksGrid() {
            const container = document.getElementById('booksGridContainer');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const booksToShow = filteredBooks.slice(startIndex, endIndex);

            if (booksToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Không tìm thấy sách nào</p>
                    </div>
                `;
                return;
            }

            let html = '';
            booksToShow.forEach(book => {
                const status = getBookDisplayStatus(book);
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';

                html += `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">${book.title}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <strong>Mã:</strong> ${book.id}<br>
                                        <strong>Tác giả:</strong> ${authorName}<br>
                                        <strong>Loại:</strong> ${categoryName}
                                    </small>
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="status-badge ${status.class}">${status.text}</span>
                                    <span class="badge bg-info">${status.available}/${book.totalCopies}</span>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="book-actions justify-content-center">
                                    <button class="btn-action btn-view" onclick="viewBookDetails('${book.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-edit" onclick="editBook('${book.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteBook('${book.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Toggle view between table and grid
        function toggleView(view) {
            currentView = view;

            // Update buttons
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');

            // Toggle views
            document.getElementById('tableView').classList.toggle('d-none', view !== 'table');
            document.getElementById('gridView').classList.toggle('d-none', view !== 'grid');

            // Redisplay books
            displayBooks();
        }

        // Search books
        function handleSearch(event) {
            if (event.key === 'Enter') {
                searchBooks();
            }
        }

        function searchBooks() {
            const searchTerm = document.getElementById('searchInput').value.trim();

            // Filter by existing filters first to narrow down the search pool if active
            let tempFilteredBooks = [...window.dataManager.getAllBooks()];
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            tempFilteredBooks = tempFilteredBooks.filter(book => {
                let matchCategory = !categoryFilter || book.categoryId === categoryFilter;
                let matchStatus = true;

                if (statusFilter) {
                    const status = getBookDisplayStatus(book); // Get real-time status
                    switch (statusFilter) {
                        case 'available':
                            matchStatus = status.available > 0;
                            break;
                        case 'borrowed':
                            matchStatus = book.borrowedCopies > 0;
                            break;
                        case 'reserved':
                            matchStatus = book.reservedCopies > 0;
                            break;
                        case 'unavailable':
                            matchStatus = (status.available === 0 && book.borrowedCopies === 0 && book.reservedCopies === 0);
                            break;
                    }
                }
                return matchCategory && matchStatus;
            });


            if (searchTerm === '') {
                filteredBooks = tempFilteredBooks;
            } else {
                // Use dataManager.searchBooks for the search term, on the pre-filtered set
                filteredBooks = window.dataManager.searchBooks(searchTerm, {
                    // Pass existing category and status filters if they were selected directly via search
                    categoryId: categoryFilter || undefined,
                    status: statusFilter || undefined
                }).filter(book => tempFilteredBooks.includes(book)); // Ensure it's still within the pre-filtered set
            }

            currentPage = 1;
            displayBooks();
            updatePagination();
        }

        // Filter books
        function filterBooks() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            // Start with all current books (already loaded from data.js)
            filteredBooks = [...currentBooks];

            // Apply category filter
            if (categoryFilter) {
                filteredBooks = filteredBooks.filter(book => book.categoryId === categoryFilter);
            }

            // Apply status filter
            if (statusFilter) {
                filteredBooks = filteredBooks.filter(book => {
                    const status = getBookDisplayStatus(book); // Get real-time status
                    switch (statusFilter) {
                        case 'available':
                            return status.available > 0;
                        case 'borrowed':
                            return book.borrowedCopies > 0;
                        case 'reserved':
                            return book.reservedCopies > 0;
                        case 'unavailable':
                            return (status.available === 0 && book.borrowedCopies === 0 && book.reservedCopies === 0);
                        default:
                            return true;
                    }
                });
            }

            // Apply search if exists (re-apply search on filtered results)
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                const searchPredicate = window.app.createSearchFilter(searchTerm, [
                    'title', 'isbn', 'description', 'location', 'tags'
                ]);
                filteredBooks = filteredBooks.filter(searchPredicate);
            }

            currentPage = 1;
            displayBooks();
            updatePagination();
        }


        // Sort books
        function sortBooks() {
            const sortBy = document.getElementById('sortBy').value;

            filteredBooks = window.app.sortData(filteredBooks, sortBy, 'asc'); // Default to asc, can add a toggle for direction

            displayBooks();
        }

        // Change items per page
        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            displayBooks();
            updatePagination();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortBy').value = 'title'; // Default sort
            document.getElementById('itemsPerPage').value = '10'; // Default items per page

            loadBooks(); // Re-load all books and apply initial filters
        }

        // Refresh books
        function refreshBooks() {
            loadBooks();
            window.app.showNotification('Dữ liệu sách đã được làm mới.', 'info', 2000);
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredBooks.length / itemsPerPage);
            const pagination = document.getElementById('booksPagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredBooks.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayBooks();
                updatePagination();
            }
        }

        // Show add book modal
        function showAddBookModal() {
            editingBookId = null;
            document.getElementById('bookModalTitle').innerHTML = '<i class="fas fa-plus"></i> Thêm sách mới';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').readOnly = false;
            document.getElementById('bookStatus').value = 'available'; // Default status for new book
            populateFilterDropdowns(); // Re-populate dropdowns to ensure fresh data

            const modal = new bootstrap.Modal(document.getElementById('bookModal'));
            modal.show();
        }

        // Edit book
        function editBook(bookId) {
            const book = window.dataManager.getBook(bookId);
            if (!book) {
                window.app.showNotification('Không tìm thấy sách!', 'error');
                return;
            }

            editingBookId = bookId;
            document.getElementById('bookModalTitle').innerHTML = '<i class="fas fa-edit"></i> Chỉnh sửa sách';

            populateFilterDropdowns(); // Populate dropdowns before setting values

            // Fill form with book data
            document.getElementById('bookId').value = book.id;
            document.getElementById('bookId').readOnly = true;
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookCategory').value = book.categoryId;
            document.getElementById('bookAuthor').value = book.authorId;
            document.getElementById('bookQuantity').value = book.totalCopies;
            document.getElementById('bookStatus').value = book.status; // Current status
            document.getElementById('bookYear').value = book.publicationYear || '';
            document.getElementById('bookPublisher').value = book.publisherId || '';
            document.getElementById('bookLocation').value = book.location || '';
            document.getElementById('bookDescription').value = book.description || '';
            document.getElementById('bookISBN').value = book.isbn || '';

            const modal = new bootstrap.Modal(document.getElementById('bookModal'));
            modal.show();
        }

        // Save book
        function saveBook() {
            const form = document.getElementById('bookForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const bookData = {
                id: document.getElementById('bookId').value.trim(),
                title: document.getElementById('bookTitle').value.trim(),
                categoryId: document.getElementById('bookCategory').value,
                authorId: document.getElementById('bookAuthor').value,
                totalCopies: parseInt(document.getElementById('bookQuantity').value),
                publicationYear: parseInt(document.getElementById('bookYear').value) || null,
                publisherId: document.getElementById('bookPublisher').value || null,
                location: document.getElementById('bookLocation').value.trim() || null,
                description: document.getElementById('bookDescription').value.trim() || null,
                isbn: document.getElementById('bookISBN').value.trim() || null,
                // status and availableCopies are managed by data.js
            };

            window.app.showLoading('Đang lưu sách...');

            setTimeout(() => {
                try {
                    if (editingBookId) {
                        // Update existing book
                        window.dataManager.updateBook(bookData.id, bookData);
                        window.app.showNotification('Cập nhật sách thành công!', 'success');
                    } else {
                        // Add new book
                        // Validate book ID uniqueness for new books
                        if (window.dataManager.getBook(bookData.id)) {
                            window.app.showNotification('Mã sách đã tồn tại!', 'error');
                            window.app.hideLoading();
                            return;
                        }
                        window.dataManager.addBook(bookData);
                        window.app.showNotification('Thêm sách mới thành công!', 'success');
                    }

                    // Refresh data
                    loadBooks();

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bookModal'));
                    modal.hide();

                } catch (error) {
                    window.app.showNotification(`Lỗi: ${error.message}`, 'error');
                    console.error('Save book error:', error);
                } finally {
                    window.app.hideLoading();
                }
            }, 1000);
        }

        // View book details
        function viewBookDetails(bookId) {
            const book = window.dataManager.getBook(bookId);
            if (!book) {
                window.app.showNotification('Không tìm thấy sách!', 'error');
                return;
            }

            const status = getBookDisplayStatus(book); // Current display status
            const author = window.dataManager.getAllAuthors().find(a => a.id === book.authorId);
            const category = window.dataManager.getAllCategories().find(c => c.id === book.categoryId);
            const publisher = window.dataManager.getAllPublishers().find(p => p.id === book.publisherId);
            const borrowHistory = window.dataManager.getBorrowRecords({ bookId: book.id }); // Get all borrow records for this book

            const detailsContent = document.getElementById('bookDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Thông tin cơ bản</h6>
                        <table class="table table-borderless">
                            <tr><td><strong>Mã sách:</strong></td><td>${book.id}</td></tr>
                            <tr><td><strong>Tên sách:</strong></td><td>${book.title}</td></tr>
                            <tr><td><strong>Tác giả:</strong></td><td>${author?.name || 'Không rõ'}</td></tr>
                            <tr><td><strong>Loại sách:</strong></td><td><span class="badge bg-secondary">${category?.name || 'Không rõ'}</span></td></tr>
                            <tr><td><strong>Số lượng:</strong></td><td><span class="badge bg-info">${book.availableCopies}/${book.totalCopies}</span></td></tr>
                            <tr><td><strong>Đang mượn:</strong></td><td><span class="badge bg-warning">${book.borrowedCopies}</span></td></tr>
                            <tr><td><strong>Đang đặt trước:</strong></td><td><span class="badge bg-info">${book.reservedCopies}</span></td></tr>
                            <tr><td><strong>Trạng thái:</strong></td><td><span class="status-badge ${status.class}">${status.text}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Thông tin chi tiết</h6>
                        <table class="table table-borderless">
                            <tr><td><strong>ISBN:</strong></td><td>${book.isbn || 'Chưa có'}</td></tr>
                            <tr><td><strong>Năm XB:</strong></td><td>${book.publicationYear || 'Chưa có'}</td></tr>
                            <tr><td><strong>Nhà XB:</strong></td><td>${publisher?.name || 'Chưa có'}</td></tr>
                            <tr><td><strong>Vị trí:</strong></td><td>${book.location || 'Chưa có'}</td></tr>
                            <tr><td><strong>Ngôn ngữ:</strong></td><td>${book.language || 'Tiếng Việt'}</td></tr>
                            <tr><td><strong>Số trang:</strong></td><td>${book.pages || 'N/A'}</td></tr>
                            <tr><td><strong>Ngày thêm:</strong></td><td>${window.app.formatDate(book.addedDate)}</td></tr>
                            <tr><td><strong>Mượn lần cuối:</strong></td><td>${book.lastBorrowed ? window.app.formatDate(book.lastBorrowed) : 'Chưa có'}</td></tr>
                        </table>
                    </div>
                </div>

                ${book.description ? `
                    <div class="mt-3">
                        <h6 class="text-primary">Mô tả</h6>
                        <p class="text-muted">${book.description}</p>
                    </div>
                ` : ''}

                <div class="mt-3">
                    <h6 class="text-primary">Lịch sử mượn gần đây</h6>
                    ${borrowHistory.length > 0 ? `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Độc giả</th>
                                        <th>Ngày mượn</th>
                                        <th>Hạn trả</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${borrowHistory.sort((a, b) => b.borrowDate - a.borrowDate).slice(0, 5).map(borrow => {
                                        const reader = window.dataManager.getReader(borrow.readerId);
                                        const isOverdue = new Date(borrow.dueDate) < new Date() && borrow.status !== 'returned';
                                        return `
                                            <tr>
                                                <td>${reader ? reader.fullName : 'Không tìm thấy'}</td>
                                                <td>${window.app.formatDate(borrow.borrowDate)}</td>
                                                <td>${window.app.formatDate(borrow.dueDate)}</td>
                                                <td><span class="badge ${isOverdue ? 'bg-danger' : (borrow.status === 'returned' ? 'bg-success' : 'bg-warning')}">${borrow.status === 'borrowed' ? 'Đang mượn' : (borrow.status === 'overdue' ? 'Quá hạn' : 'Đã trả')}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p class="text-muted">Chưa có lịch sử mượn</p>'}
                </div>
            `;

            // Store current book ID for edit button
            window.currentDetailBookId = bookId;

            const modal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
            modal.show();
        }

        // Edit book from details modal
        function editBookFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('bookDetailsModal'));
            modal.hide();

            setTimeout(() => {
                editBook(window.currentDetailBookId);
            }, 300);
        }

        // Delete book
        function deleteBook(bookId) {
            const book = window.dataManager.getBook(bookId);
            if (!book) {
                window.app.showNotification('Không tìm thấy sách!', 'error');
                return;
            }

            // Check if book has active borrows or reservations
            const activeBorrows = window.dataManager.getBorrowRecords({ bookId: book.id, status: 'borrowed' });
            const activeReservations = window.dataManager.getAllReservations().filter(r => r.bookId === book.id && r.status === 'active');

            if (activeBorrows.length > 0) {
                window.app.showNotification('Không thể xóa sách đang được mượn!', 'error');
                return;
            }
            if (activeReservations.length > 0) {
                window.app.showNotification('Không thể xóa sách đang có người đặt trước!', 'error');
                return;
            }

            bookToDelete = bookId;

            // Show book info in delete modal
            document.getElementById('deleteBookInfo').innerHTML = `
                <strong>Mã sách:</strong> ${book.id}<br>
                <strong>Tên sách:</strong> ${book.title}<br>
                <strong>Tác giả:</strong> ${window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ'}<br>
                <strong>Loại:</strong> ${window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ'}
            `;

            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // Confirm delete book
        function confirmDeleteBook() {
            if (!bookToDelete) return;

            window.app.showLoading('Đang xóa sách...');

            setTimeout(() => {
                try {
                    window.dataManager.deleteBook(bookToDelete);
                    window.app.showNotification('Xóa sách thành công!', 'success');

                    // Refresh data
                    loadBooks();

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();

                    bookToDelete = null;
                } catch (error) {
                    window.app.showNotification(`Lỗi: ${error.message}`, 'error');
                    console.error('Delete book error:', error);
                } finally {
                    window.app.hideLoading();
                }
            }, 1000);
        }

        // Export books to CSV (Excel compatible)
        function exportBooks() {
            window.app.showLoading('Đang xuất dữ liệu sách...');

            // Simulate export delay
            setTimeout(() => {
                const csvContent = generateBooksCSV();
                window.app.downloadFile(csvContent, 'danh-sach-sach.csv', 'text/csv;charset=utf-8;');
                window.app.showNotification('Xuất file thành công!', 'success');
                window.app.hideLoading();
            }, 1000);
        }

        // Generate CSV content
        function generateBooksCSV() {
            const headers = [
                'Mã sách', 'Tên sách', 'Loại sách', 'Tác giả', 'Nhà xuất bản',
                'ISBN', 'Năm xuất bản', 'Số lượng tổng', 'Số lượng có sẵn',
                'Số lượng đang mượn', 'Số lượng đặt trước', 'Vị trí', 'Mô tả',
                'Tình trạng', 'Ngày thêm'
            ];
            const rows = currentBooks.map(book => {
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';
                const publisherName = window.dataManager.getAllPublishers().find(p => p.id === book.publisherId)?.name || 'Không rõ';

                return [
                    book.id,
                    book.title,
                    categoryName,
                    authorName,
                    publisherName,
                    book.isbn || '',
                    book.publicationYear || '',
                    book.totalCopies,
                    book.availableCopies,
                    book.borrowedCopies,
                    book.reservedCopies,
                    book.location || '',
                    book.description || '',
                    getBookDisplayStatus(book).text, // Use human-readable status
                    window.app.formatDate(book.addedDate)
                ];
            });

            return [headers, ...rows].map(row =>
                row.map(field => {
                    const stringField = String(field);
                    // Escape quotes and wrap in quotes if contains comma or new line
                    if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                        return '"' + stringField.replace(/"/g, '""') + '"';
                    }
                    return stringField;
                }).join(',')
            ).join('\n');
        }

        // Logout function
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                window.app.logout(); // Use logout from app.js
            }
        }
    </script>
</body>
</html>
