<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mượn/Trả sách - Hệ thống quản lý thư viện</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-custom {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            padding: 20px 0;
        }

        .page-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .action-tabs {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .borrow-return-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
            color: white;
        }

        .btn-success-custom {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
        }

        .btn-success-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
            color: white;
        }

        .btn-danger-custom {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: none;
            color: white;
        }

        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
            color: white;
        }

        .btn-warning-custom {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
        }

        .btn-warning-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
            color: white;
        }

        .nav-tabs-custom {
            border-bottom: 3px solid #e74c3c;
        }

        .nav-tabs-custom .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            padding: 15px 25px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tabs-custom .nav-link:hover {
            background: #f8f9fa;
            color: #e74c3c;
        }

        .nav-tabs-custom .nav-link.active {
            background: #e74c3c;
            color: white;
            border-bottom: 3px solid #e74c3c;
        }

        .search-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
        }

        .search-result {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .search-result:hover {
            border-color: #e74c3c;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.1);
        }

        .search-result.selected {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .reader-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .book-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .book-item:hover {
            border-color: #27ae60;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.1);
        }

        .book-item.overdue {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .book-item.selected {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-borrowed {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-returned {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-renewed {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-active-reader { /* for active reader status */
            background: #d4edda;
            color: #155724;
        }
        .status-suspended-reader { /* for suspended reader status */
            background: #f8d7da;
            color: #721c24;
        }
        .status-expired-reader { /* for expired reader status */
            background: #ffe3b3;
            color: #cc8400;
        }

        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .table-custom thead {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .table-custom thead th {
            border: none;
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-custom tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }

        .table-custom tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .stats-row {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quick-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            width: 100%;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            background: white;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            border-color: #e74c3c;
            background: #fff5f5;
            transform: translateY(-2px);
        }

        .barcode-scanner {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .barcode-scanner.active {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-custom .modal-header {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .receipt-print {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .fine-calculator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .fine-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #856404;
        }

        @media (max-width: 768px) {
            .btn-custom {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .table-responsive {
                font-size: 0.9rem;
            }

            .search-result, .book-item {
                padding: 10px;
            }

            .reader-info {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-exchange-alt"></i>
                Mượn/Trả sách
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="books.html">
                            <i class="fas fa-book"></i> Quản lý sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="readers.html">
                            <i class="fas fa-users"></i> Quản lý độc giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="borrow-return.html">
                            <i class="fas fa-exchange-alt"></i> Mượn/Trả sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="fas fa-chart-bar"></i> Báo cáo
                        </a>
                    </li>
                </ul>

                <div class="navbar-nav">
                    <span class="nav-link">
                        <i class="fas fa-user"></i>
                        <span id="currentUser">Admin</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">
                        <i class="fas fa-exchange-alt text-danger"></i>
                        Mượn/Trả sách
                    </h2>
                    <p class="text-muted mb-0">Quản lý việc mượn và trả sách của độc giả</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary-custom btn-custom" onclick="showBorrowHistoryModal()">
                        <i class="fas fa-history"></i> Lịch sử mượn/trả
                    </button>
                    <button class="btn btn-warning-custom btn-custom" onclick="showOverdueModal()">
                        <i class="fas fa-exclamation-triangle"></i> Sách quá hạn
                    </button>
                    <button class="btn btn-success-custom btn-custom" onclick="printDailyReport()">
                        <i class="fas fa-print"></i> In báo cáo
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="row">
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-primary" id="todayBorrowCount">0</div>
                        <div class="stat-label">Mượn hôm nay</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-success" id="todayReturnCount">0</div>
                        <div class="stat-label">Trả hôm nay</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-warning" id="totalBorrowedCount">0</div>
                        <div class="stat-label">Đang mượn</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-danger" id="overdueCount">0</div>
                        <div class="stat-label">Quá hạn</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-info" id="renewedCount">0</div>
                        <div class="stat-label">Gia hạn</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="stat-item">
                        <div class="stat-number text-secondary" id="totalFineAmount">0đ</div>
                        <div class="stat-label">Tổng phí phạt</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-tabs">
            <ul class="nav nav-tabs nav-tabs-custom" id="actionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="borrow-tab" data-bs-toggle="tab" data-bs-target="#borrow" type="button" role="tab">
                        <i class="fas fa-plus-circle"></i> Mượn sách
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="return-tab" data-bs-toggle="tab" data-bs-target="#return" type="button" role="tab">
                        <i class="fas fa-undo"></i> Trả sách
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="renew-tab" data-bs-toggle="tab" data-bs-target="#renew" type="button" role="tab">
                        <i class="fas fa-calendar-plus"></i> Gia hạn
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab">
                        <i class="fas fa-search"></i> Tra cứu
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-4" id="actionTabsContent">
                <div class="tab-pane fade show active" id="borrow" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="search-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-user-search text-primary"></i>
                                    Tìm độc giả
                                </h5>

                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="readerSearchInput"
                                                   placeholder="Nhập mã thẻ hoặc tên độc giả..."
                                                   onkeyup="handleReaderSearch(event)">
                                            <button class="btn btn-primary-custom" onclick="searchReader()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-secondary w-100" onclick="scanReaderCard()">
                                            <i class="fas fa-qrcode"></i> Quét mã thẻ
                                        </button>
                                    </div>
                                </div>

                                <div id="readerSearchResults"></div>
                            </div>

                            <div id="selectedReaderInfo" class="d-none">
                                <div class="reader-info">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h5 class="mb-1" id="selectedReaderName">Tên độc giả</h5>
                                            <p class="mb-1">
                                                <strong>Mã thẻ:</strong> <span id="selectedReaderId"></span> |
                                                <strong>Lớp:</strong> <span id="selectedReaderClass"></span>
                                            </p>
                                            <p class="mb-0">
                                                <strong>Hạn thẻ:</strong> <span id="selectedReaderExpiry"></span> |
                                                <strong>Đang mượn:</strong> <span id="selectedReaderBorrowed">0</span> sách
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-light" onclick="clearSelectedReader()">
                                                <i class="fas fa-times"></i> Hủy chọn
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="search-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-book text-success"></i>
                                    Chọn sách mượn
                                </h5>

                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="bookSearchInput"
                                                   placeholder="Nhập mã sách hoặc tên sách..."
                                                   onkeyup="handleBookSearch(event)">
                                            <button class="btn btn-success-custom" onclick="searchBook()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-secondary w-100" onclick="scanBookBarcode()">
                                            <i class="fas fa-barcode"></i> Quét mã vạch
                                        </button>
                                    </div>
                                </div>

                                <div id="bookSearchResults"></div>
                            </div>

                            <div id="selectedBooksSection" class="d-none">
                                <h5 class="mb-3">
                                    <i class="fas fa-list text-warning"></i>
                                    Sách đã chọn (<span id="selectedBooksCount">0</span>)
                                </h5>
                                <div id="selectedBooksList"></div>

                                <div class="mt-3">
                                    <button class="btn btn-danger-custom btn-custom" onclick="processBorrow()">
                                        <i class="fas fa-check"></i> Xác nhận mượn sách
                                    </button>
                                    <button class="btn btn-outline-secondary btn-custom" onclick="clearSelectedBooks()">
                                        <i class="fas fa-times"></i> Xóa tất cả
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="quick-actions">
                                <h6 class="mb-3">
                                    <i class="fas fa-bolt text-warning"></i>
                                    Thao tác nhanh
                                </h6>

                                <button class="quick-action-btn" onclick="showPopularBooksModal()">
                                    <i class="fas fa-star text-warning"></i>
                                    <div class="mt-2">
                                        <strong>Sách phổ biến</strong>
                                        <small class="d-block text-muted">Chọn từ sách hay mượn</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showNewBooksModal()">
                                    <i class="fas fa-plus text-success"></i>
                                    <div class="mt-2">
                                        <strong>Sách mới</strong>
                                        <small class="d-block text-muted">Sách mới nhập gần đây</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showRecommendedBooksModal()">
                                    <i class="fas fa-thumbs-up text-info"></i>
                                    <div class="mt-2">
                                        <strong>Gợi ý cho độc giả</strong>
                                        <small class="d-block text-muted">Dựa trên lịch sử mượn</small>
                                    </div>
                                </button>
                            </div>

                            <div class="barcode-scanner" id="barcodeScanner">
                                <i class="fas fa-qrcode fa-3x text-muted mb-3"></i>
                                <h6>Quét mã vạch</h6>
                                <p class="text-muted mb-3">Nhấn để kích hoạt camera quét mã</p>
                                <button class="btn btn-outline-primary" onclick="toggleBarcodeScanner()">
                                    <i class="fas fa-camera"></i> Bật camera
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="return" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="search-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-user-check text-primary"></i>
                                    Tìm độc giả trả sách
                                </h5>

                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="returnReaderSearchInput"
                                                   placeholder="Nhập mã thẻ hoặc tên độc giả..."
                                                   onkeyup="handleReturnReaderSearch(event)">
                                            <button class="btn btn-primary-custom" onclick="searchReturnReader()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-secondary w-100" onclick="scanReturnReaderCard()">
                                            <i class="fas fa-qrcode"></i> Quét mã thẻ
                                        </button>
                                    </div>
                                </div>

                                <div id="returnReaderSearchResults"></div>
                            </div>

                            <div id="borrowedBooksSection" class="d-none">
                                <div class="reader-info">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h5 class="mb-1" id="returnReaderName">Tên độc giả</h5>
                                            <p class="mb-1">
                                                <strong>Mã thẻ:</strong> <span id="returnReaderId"></span> |
                                                <strong>Lớp:</strong> <span id="returnReaderClass"></span>
                                            </p>
                                            <p class="mb-0">
                                                <strong>Đang mượn:</strong> <span id="returnReaderBorrowedCount">0</span> sách |
                                                <strong>Quá hạn:</strong> <span id="returnReaderOverdueCount">0</span> sách
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-light" onclick="clearReturnReader()">
                                                <i class="fas fa-times"></i> Hủy chọn
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <h5 class="mb-3">
                                    <i class="fas fa-books text-warning"></i>
                                    Sách đang mượn
                                </h5>

                                <div id="borrowedBooksList"></div>

                                <div id="fineCalculator" class="fine-calculator d-none">
                                    <h6><i class="fas fa-calculator text-warning"></i> Tính phí phạt</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Số ngày quá hạn:</strong> <span id="overdueDays">0</span> ngày</p>
                                            <p class="mb-1"><strong>Phí phạt/ngày:</strong> ${window.app.formatCurrency(window.app.getSystemSettings().finePerDay || 2000)}</p>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <div class="fine-amount" id="totalFine">0đ</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-success-custom btn-custom" onclick="processReturn()">
                                        <i class="fas fa-check"></i> Xác nhận trả sách
                                    </button>
                                    <button class="btn btn-warning-custom btn-custom" onclick="processReturnWithFine()">
                                        <i class="fas fa-money-bill"></i> Trả sách + Thu phí
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="quick-actions">
                                <h6 class="mb-3">
                                    <i class="fas fa-bolt text-success"></i>
                                    Trả sách nhanh
                                </h6>

                                <div class="search-section">
                                    <label class="form-label">Quét mã sách trả:</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="quickReturnBookCode"
                                               placeholder="Mã sách..."
                                               onkeyup="handleQuickReturn(event)">
                                        <button class="btn btn-success-custom" onclick="quickReturnBook()">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                </div>

                                <button class="quick-action-btn" onclick="showOverdueBooksModal()">
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                    <div class="mt-2">
                                        <strong>Sách quá hạn</strong>
                                        <small class="d-block text-muted">Danh sách sách quá hạn</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showDueTodayModal()">
                                    <i class="fas fa-clock text-warning"></i>
                                    <div class="mt-2">
                                        <strong>Hết hạn hôm nay</strong>
                                        <small class="d-block text-muted">Sách hết hạn trong ngày</small>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="renew" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="search-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-user-clock text-primary"></i>
                                    Tìm độc giả gia hạn
                                </h5>

                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="renewReaderSearchInput"
                                                   placeholder="Nhập mã thẻ hoặc tên độc giả..."
                                                   onkeyup="handleRenewReaderSearch(event)">
                                            <button class="btn btn-primary-custom" onclick="searchRenewReader()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-secondary w-100" onclick="scanRenewReaderCard()">
                                            <i class="fas fa-qrcode"></i> Quét mã thẻ
                                        </button>
                                    </div>
                                </div>

                                <div id="renewReaderSearchResults"></div>
                            </div>

                            <div id="renewableBooksSection" class="d-none">
                                <div class="reader-info">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h5 class="mb-1" id="renewReaderName">Tên độc giả</h5>
                                            <p class="mb-1">
                                                <strong>Mã thẻ:</strong> <span id="renewReaderId"></span> |
                                                <strong>Lớp:</strong> <span id="renewReaderClass"></span>
                                            </p>
                                            <p class="mb-0">
                                                <strong>Có thể gia hạn:</strong> <span id="renewableCount">0</span> sách
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-light" onclick="clearRenewReader()">
                                                <i class="fas fa-times"></i> Hủy chọn
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <h5 class="mb-3">
                                    <i class="fas fa-calendar-plus text-info"></i>
                                    Chọn sách gia hạn
                                </h5>

                                <div id="renewableBooksList"></div>

                                <div class="mt-3">
                                    <button class="btn btn-warning-custom btn-custom" onclick="processRenewal()">
                                        <i class="fas fa-calendar-plus"></i> Xác nhận gia hạn
                                    </button>
                                    <button class="btn btn-primary-custom btn-custom" onclick="renewAllBooks()">
                                        <i class="fas fa-calendar-check"></i> Gia hạn tất cả
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="quick-actions">
                                <h6 class="mb-3">
                                    <i class="fas fa-info-circle text-info"></i>
                                    Quy định gia hạn
                                </h6>

                                <div class="alert alert-info">
                                    <ul class="mb-0">
                                        <li>Mỗi sách chỉ được gia hạn tối đa ${window.app.getSystemSettings().maxRenewals || 2} lần</li>
                                        <li>Thời gian gia hạn: ${window.app.getSystemSettings().maxBorrowDays || 14} ngày</li>
                                        <li>Không gia hạn sách quá hạn</li>
                                        <li>Không gia hạn khi có sách khác quá hạn</li>
                                        <li>Phí gia hạn: ${window.app.formatCurrency(5000)}/sách</li>
                                    </ul>
                                </div>

                                <button class="quick-action-btn" onclick="showRenewalHistoryModal()">
                                    <i class="fas fa-history text-info"></i>
                                    <div class="mt-2">
                                        <strong>Lịch sử gia hạn</strong>
                                        <small class="d-block text-muted">Xem lịch sử gia hạn</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showRenewalStatsModal()">
                                    <i class="fas fa-chart-bar text-success"></i>
                                    <div class="mt-2">
                                        <strong>Thống kê gia hạn</strong>
                                        <small class="d-block text-muted">Báo cáo gia hạn</small>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="search" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="search-section">
                                <h5 class="mb-3">
                                    <i class="fas fa-search-plus text-primary"></i>
                                    Tra cứu nâng cao
                                </h5>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tìm theo:</label>
                                        <select class="form-select" id="searchType">
                                            <option value="reader">Độc giả</option>
                                            <option value="book">Sách</option>
                                            <option value="transaction">Giao dịch</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Từ khóa:</label>
                                        <input type="text" class="form-control" id="searchKeyword"
                                               placeholder="Nhập từ khóa tìm kiếm...">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Từ ngày:</label>
                                        <input type="date" class="form-control" id="searchFromDate">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Đến ngày:</label>
                                        <input type="date" class="form-control" id="searchToDate">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Trạng thái:</label>
                                        <select class="form-select" id="searchStatus">
                                            <option value="">Tất cả</option>
                                            <option value="borrowed">Đang mượn</option>
                                            <option value="returned">Đã trả</option>
                                            <option value="overdue">Quá hạn</option>
                                            <option value="renewed">Đã gia hạn</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Lớp:</label>
                                        <select class="form-select" id="searchClass">
                                            <option value="">Tất cả lớp</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button class="btn btn-primary-custom btn-custom" onclick="performAdvancedSearch()">
                                        <i class="fas fa-search"></i> Tìm kiếm
                                    </button>
                                    <button class="btn btn-outline-secondary btn-custom" onclick="clearSearchForm()">
                                        <i class="fas fa-times"></i> Xóa form
                                    </button>
                                    <button class="btn btn-success-custom btn-custom" onclick="exportSearchResults()">
                                        <i class="fas fa-download"></i> Xuất kết quả
                                    </button>
                                </div>
                            </div>

                            <div id="searchResultsSection" class="d-none">
                                <h5 class="mb-3">
                                    <i class="fas fa-list text-success"></i>
                                    Kết quả tìm kiếm (<span id="searchResultsCount">0</span>)
                                </h5>

                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead id="searchResultsHeader">
                                            </thead>
                                        <tbody id="searchResultsBody">
                                            </tbody>
                                    </table>
                                </div>

                                <nav aria-label="Search results pagination" class="mt-4">
                                    <ul class="pagination justify-content-center" id="searchPagination">
                                        </ul>
                                </nav>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="quick-actions">
                                <h6 class="mb-3">
                                    <i class="fas fa-bolt text-warning"></i>
                                    Tra cứu nhanh
                                </h6>

                                <button class="quick-action-btn" onclick="showTodayTransactions()">
                                    <i class="fas fa-calendar-day text-primary"></i>
                                    <div class="mt-2">
                                        <strong>Giao dịch hôm nay</strong>
                                        <small class="d-block text-muted">Mượn/trả trong ngày</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showOverdueBooksQuick()">
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                    <div class="mt-2">
                                        <strong>Sách quá hạn</strong>
                                        <small class="d-block text-muted">Tất cả sách quá hạn</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showPopularBooksQuick()">
                                    <i class="fas fa-star text-warning"></i>
                                    <div class="mt-2">
                                        <strong>Sách phổ biến</strong>
                                        <small class="d-block text-muted">Sách được mượn nhiều</small>
                                    </div>
                                </button>

                                <button class="quick-action-btn" onclick="showActiveReadersQuick()">
                                    <i class="fas fa-users text-success"></i>
                                    <div class="mt-2">
                                        <strong>Độc giả tích cực</strong>
                                        <small class="d-block text-muted">Độc giả mượn nhiều</small>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="borrowConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i> Xác nhận mượn sách
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="borrowConfirmContent">
                        </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Ngày mượn:</label>
                            <input type="date" class="form-control" id="borrowDate" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hạn trả:</label>
                            <input type="date" class="form-control" id="dueDate">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Ghi chú:</label>
                        <textarea class="form-control" id="borrowNote" rows="2"
                                placeholder="Ghi chú thêm..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-danger-custom" onclick="confirmBorrow()">
                        <i class="fas fa-check"></i> Xác nhận mượn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="returnConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-undo"></i> Xác nhận trả sách
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="returnConfirmContent">
                        </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Ngày trả:</label>
                            <input type="date" class="form-control" id="returnDate" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tình trạng sách:</label>
                            <select class="form-select" id="bookCondition">
                                <option value="Tốt">Tốt</option>
                                <option value="Khá">Khá</option>
                                <option value="Kém">Kém</option>
                                <option value="Hư hỏng">Hư hỏng</option>
                            </select>
                        </div>
                    </div>

                    <div id="fineSection" class="mt-3 d-none">
                        <div class="fine-calculator">
                            <h6><i class="fas fa-money-bill-wave text-warning"></i> Phí phạt</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="mb-1"><strong>Số ngày quá hạn:</strong> <span id="confirmOverdueDays">0</span> ngày</p>
                                    <p class="mb-1"><strong>Phí phạt/ngày:</strong> ${window.app.formatCurrency(window.app.getSystemSettings().finePerDay || 2000)}</p>
                                    <p class="mb-1"><strong>Phí hư hỏng:</strong> <span id="damageFeeDisplay">0đ</span></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="fine-amount" id="confirmTotalFine">0đ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Ghi chú:</label>
                        <textarea class="form-control" id="returnNote" rows="2"
                                placeholder="Ghi chú về tình trạng sách..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-success-custom" onclick="confirmReturn()">
                        <i class="fas fa-check"></i> Xác nhận trả
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="renewConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus"></i> Xác nhận gia hạn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="renewConfirmContent">
                        </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">Hạn trả hiện tại:</label>
                            <input type="date" class="form-control" id="currentDueDate" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hạn trả mới:</label>
                            <input type="date" class="form-control" id="newDueDate" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phí gia hạn:</label>
                            <input type="text" class="form-control" id="renewalFee" readonly>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Lý do gia hạn:</label>
                        <textarea class="form-control" id="renewalReason" rows="2"
                                placeholder="Nhập lý do gia hạn..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-warning-custom" onclick="confirmRenewal()">
                        <i class="fas fa-check"></i> Xác nhận gia hạn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="receiptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt"></i> Phiếu giao dịch
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="receipt-print" id="receiptContent">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-primary-custom" onclick="printReceipt()">
                        <i class="fas fa-print"></i> In phiếu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="borrowHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> Lịch sử mượn/trả sách
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="historyFilter" onchange="filterHistory()">
                                <option value="all">Tất cả</option>
                                <option value="today">Hôm nay</option>
                                <option value="week">Tuần này</option>
                                <option value="month">Tháng này</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="historyType" onchange="filterHistory()">
                                <option value="all">Tất cả giao dịch</option>
                                <option value="borrow">Chỉ mượn</option>
                                <option value="return">Chỉ trả</option>
                                <option value="renew">Chỉ gia hạn</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="historySearch"
                                   placeholder="Tìm theo tên độc giả hoặc sách..." onkeyup="filterHistory()">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary-custom w-100" onclick="filterHistory()">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Thời gian</th>
                                    <th>Độc giả</th>
                                    <th>Sách</th>
                                    <th>Loại giao dịch</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success-custom" onclick="exportHistory()">
                        <i class="fas fa-download"></i> Xuất Excel
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade modal-custom" id="overdueModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-exclamation-triangle"></i> Sách quá hạn
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-select" id="overdueFilter" onchange="loadOverdueBooks()">
                                <option value="all">Tất cả</option>
                                <option value="1-7">1-7 ngày</option>
                                <option value="8-14">8-14 ngày</option>
                                <option value="15-30">15-30 ngày</option>
                                <option value="30+">Trên 30 ngày</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="overdueSearch"
                                   placeholder="Tìm theo tên độc giả hoặc sách..." onkeyup="loadOverdueBooks()">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-danger-custom w-100" onclick="sendOverdueNotifications()">
                                <i class="fas fa-bell"></i> Gửi thông báo
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Độc giả</th>
                                    <th>Sách</th>
                                    <th>Ngày mượn</th>
                                    <th>Hạn trả</th>
                                    <th>Quá hạn</th>
                                    <th>Phí phạt</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning-custom" onclick="exportOverdueList()">
                        <i class="fas fa-download"></i> Xuất danh sách
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3">Đang xử lý...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/data.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Global variables
        let selectedReader = null;
        let selectedBooks = []; // For borrow tab
        let selectedReturnReader = null;
        let selectedReturnBooks = []; // For return tab (array of borrow record IDs)
        let selectedRenewReader = null;
        let selectedRenewBooks = []; // For renew tab (array of borrow record IDs)
        let currentSearchResults = []; // For search tab
        let currentSearchPage = 1; // For search pagination
        let searchItemsPerPage = 10; // For search pagination


        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure dataManager is ready before proceeding
            if (typeof window.dataManager === 'undefined') {
                setTimeout(initializeBorrowReturnPage, 100); // Retry after a short delay
            } else {
                initializeBorrowReturnPage();
            }
            checkAuthentication();
            setCurrentUser();
        });

        // Check authentication
        function checkAuthentication() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return;
            }
        }

        // Set current user
        function setCurrentUser() {
            const username = sessionStorage.getItem('username') || 'Admin';
            document.getElementById('currentUser').textContent = username;
        }

        // Initialize borrow return page
        function initializeBorrowReturnPage() {
            // Set default dates for borrow form
            const today = new Date();
            const dueDate = new Date();
            dueDate.setDate(today.getDate() + (window.app.getSystemSettings().maxBorrowDays || 14)); // Default loan period
            document.getElementById('borrowDate').value = window.app.formatDate(today, 'yyyy-mm-dd');
            document.getElementById('dueDate').value = window.app.formatDate(dueDate, 'yyyy-mm-dd');
            document.getElementById('returnDate').value = window.app.formatDate(today, 'yyyy-mm-dd');

            // Set search date range (last 30 days)
            const fromDate = new Date();
            fromDate.setDate(today.getDate() - 30);
            document.getElementById('searchFromDate').value = window.app.formatDate(fromDate, 'yyyy-mm-dd');
            document.getElementById('searchToDate').value = window.app.formatDate(today, 'yyyy-mm-dd');

            loadStatistics();
            loadClassOptions(); // For search tab
            // Attach event listener for tab changes to reset relevant sections
            document.querySelectorAll('#actionTabs button').forEach(tabButton => {
                tabButton.addEventListener('shown.bs.tab', function (event) {
                    const targetTabId = event.target.getAttribute('data-bs-target');
                    if (targetTabId === '#borrow') {
                        clearSelectedReader();
                    } else if (targetTabId === '#return') {
                        clearReturnReader();
                    } else if (targetTabId === '#renew') {
                        clearRenewReader();
                    } else if (targetTabId === '#search') {
                        clearSearchForm();
                    }
                    loadStatistics(); // Refresh stats on tab change
                });
            });
        }

        // Load statistics
        function loadStatistics() {
            if (typeof window.dataManager === 'undefined') {
                return; // Wait for dataManager to be loaded
            }
            const stats = window.dataManager.getStatistics(); //
            document.getElementById('todayBorrowCount').textContent = stats.borrows.today; //
            document.getElementById('todayReturnCount').textContent = stats.returns.today; //
            document.getElementById('totalBorrowedCount').textContent = stats.borrows.active; //
            document.getElementById('overdueCount').textContent = stats.borrows.overdue; //
            document.getElementById('renewedCount').textContent = stats.renewals.total; // Total renewals count from data.js
            document.getElementById('totalFineAmount').textContent = window.app.formatCurrency(stats.fines.unpaidAmount); //
        }

        // Load class options for search tab
        function loadClassOptions() {
            if (typeof window.dataManager === 'undefined') {
                return;
            }
            const allReaders = window.dataManager.getAllReaders(); //
            const uniqueClasses = [...new Set(allReaders.map(r => r.className))].sort(); //
            const searchClassSelect = document.getElementById('searchClass'); //

            searchClassSelect.innerHTML = '<option value="">Tất cả lớp</option>'; //
            uniqueClasses.forEach(className => { //
                searchClassSelect.innerHTML += `<option value="${className}">${className}</option>`; //
            });
        }

        // BORROW FUNCTIONS

        // Handle reader search (on keyup or button click)
        function handleReaderSearch(event) {
            if (event.key === 'Enter') {
                searchReader();
            }
        }

        // Search reader
        function searchReader() {
            const searchTerm = document.getElementById('readerSearchInput').value.trim(); //
            if (!searchTerm) {
                window.app.showNotification('Vui lòng nhập mã thẻ hoặc tên độc giả!', 'error'); //
                return;
            }

            window.app.showLoading('Đang tìm độc giả...'); //

            setTimeout(() => {
                const readers = window.dataManager.searchReaders(searchTerm); //
                displayReaderSearchResults(readers); //
                window.app.hideLoading(); //
            }, 500);
        }

        // Display reader search results
        function displayReaderSearchResults(readers) {
            const container = document.getElementById('readerSearchResults'); //

            if (readers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Không tìm thấy độc giả nào!
                    </div>
                `; //
                return;
            }

            let html = '';
            readers.forEach(reader => { //
                const status = getReaderDisplayStatus(reader); // Use display status
                const borrowedCount = getReaderBorrowedBooks(reader.id).length; //
                const canBorrow = canReaderBorrow(reader); //

                html += `
                    <div class="search-result ${canBorrow ? '' : 'border-danger'}" onclick="selectReader('${reader.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${reader.fullName}</h6>
                                <p class="mb-1">
                                    <strong>Mã thẻ:</strong> ${reader.id} |
                                    <strong>Lớp:</strong> ${reader.className}
                                </p>
                                <p class="mb-0">
                                    <span class="status-badge ${status.class}">${status.text}</span>
                                    <span class="ms-2">Đang mượn: <strong>${borrowedCount}</strong> sách</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                ${canBorrow ?
                                    '<button class="btn btn-primary-custom btn-sm">Chọn</button>' :
                                    '<span class="text-danger"><i class="fas fa-ban"></i> Không thể mượn</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Select reader
        function selectReader(readerId) {
            const reader = window.dataManager.getReader(readerId); //
            if (!reader) return;

            if (!canReaderBorrow(reader)) {
                window.app.showNotification('Độc giả này không thể mượn sách!', 'error'); //
                return;
            }

            selectedReader = reader; //

            // Update UI
            document.getElementById('selectedReaderName').textContent = reader.fullName; //
            document.getElementById('selectedReaderId').textContent = reader.id; //
            document.getElementById('selectedReaderClass').textContent = reader.className; //
            document.getElementById('selectedReaderExpiry').textContent = window.app.formatDate(reader.hanThe); //
            document.getElementById('selectedReaderBorrowed').textContent = getReaderBorrowedBooks(reader.id).length; //

            document.getElementById('selectedReaderInfo').classList.remove('d-none'); //
            document.getElementById('readerSearchResults').innerHTML = ''; // Clear results
            document.getElementById('readerSearchInput').value = ''; // Clear search input

            window.app.showNotification(`Đã chọn độc giả: ${reader.fullName}`, 'success'); //
        }

        // Clear selected reader
        function clearSelectedReader() {
            selectedReader = null; //
            selectedBooks = []; //
            document.getElementById('selectedReaderInfo').classList.add('d-none'); //
            document.getElementById('selectedBooksSection').classList.add('d-none'); //
            document.getElementById('bookSearchInput').value = ''; //
            document.getElementById('readerSearchInput').value = ''; //
            document.getElementById('readerSearchResults').innerHTML = ''; //
            updateSelectedBooksDisplay(); //
        }

        // Determine if a reader can borrow (business logic)
        function canReaderBorrow(reader) {
            const status = getReaderDisplayStatus(reader); // Get current display status
            const borrowedCount = getReaderBorrowedBooks(reader.id).length; //
            const hasOverdue = window.dataManager.getOverdueBooks().some(br => br.readerId === reader.id); // Check for overdue
            const hasUnpaidFines = window.dataManager.getFines({ readerId: reader.id, status: 'unpaid' }).length > 0; // Check for unpaid fines

            // Check against system settings
            const maxBooksPerReader = window.app.getSystemSettings().maxBooksPerReader || 5;

            return (
                status.type === 'active' && // Must be active status
                borrowedCount < maxBooksPerReader && // Within borrow limit
                !hasOverdue && // No overdue books
                !hasUnpaidFines // No unpaid fines
            );
        }

        // Get reader display status (similar to readers.html)
        function getReaderDisplayStatus(reader) {
            const today = new Date();
            const expiryDate = new Date(reader.hanThe);
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

            if (reader.status === 'suspended') {
                return { type: 'suspended', class: 'status-suspended-reader', text: 'Tạm khóa' };
            } else if (reader.status === 'warning') {
                return { type: 'warning', class: 'status-warning-reader', text: 'Cảnh báo' };
            } else if (daysUntilExpiry < 0) {
                return { type: 'expired', class: 'status-expired-reader', text: 'Hết hạn' };
            } else if (daysUntilExpiry <= 30) {
                return { type: 'expiring', class: 'status-expiring-reader', text: 'Sắp hết hạn' };
            } else {
                return { type: 'active', class: 'status-active-reader', text: 'Hoạt động' };
            }
        }


        // Handle book search (on keyup or button click)
        function handleBookSearch(event) {
            if (event.key === 'Enter') {
                searchBook();
            }
        }

        // Search book
        function searchBook() {
            if (!selectedReader) {
                window.app.showNotification('Vui lòng chọn độc giả trước!', 'error'); //
                return;
            }

            const searchTerm = document.getElementById('bookSearchInput').value.trim(); //
            if (!searchTerm) {
                window.app.showNotification('Vui lòng nhập mã sách hoặc tên sách!', 'error'); //
                return;
            }

            window.app.showLoading('Đang tìm sách...'); //

            setTimeout(() => {
                const books = window.dataManager.searchBooks(searchTerm, { availability: 'available' }); // Search only available books
                displayBookSearchResults(books); //
                window.app.hideLoading(); //
            }, 500);
        }

        // Display book search results
        function displayBookSearchResults(books) {
            const container = document.getElementById('bookSearchResults'); //

            if (books.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Không tìm thấy sách nào có sẵn!
                    </div>
                `; //
                return;
            }

            let html = '';
            books.forEach(book => { //
                const isSelected = selectedBooks.some(b => b.id === book.id); // Check if already selected
                const availableCopies = book.availableCopies; // Access directly from book object

                html += `
                    <div class="search-result ${isSelected ? 'selected' : ''}" onclick="toggleBookSelection('${book.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${book.title}</h6>
                                <p class="mb-1">
                                    <strong>Mã sách:</strong> ${book.id} |
                                    <strong>Tác giả:</strong> ${window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ'}
                                </p>
                                <p class="mb-0">
                                    <strong>Thể loại:</strong> ${window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ'} |
                                    <strong>Có sẵn:</strong> ${availableCopies} cuốn
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn ${isSelected ? 'btn-danger' : 'btn-success'} btn-sm">
                                    <i class="fas ${isSelected ? 'fa-minus' : 'fa-plus'}"></i>
                                    ${isSelected ? 'Bỏ chọn' : 'Chọn'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Toggle book selection for borrowing
        function toggleBookSelection(bookId) {
            const book = window.dataManager.getBook(bookId); //
            if (!book) return;

            const existingIndex = selectedBooks.findIndex(b => b.id === bookId); //

            if (existingIndex >= 0) {
                // Remove book
                selectedBooks.splice(existingIndex, 1); //
                window.app.showNotification(`Đã bỏ chọn: ${book.title}`, 'info'); //
            } else {
                // Add book
                const maxBooksPerReader = window.app.getSystemSettings().maxBooksPerReader || 5; //
                if (selectedBooks.length >= maxBooksPerReader) {
                    window.app.showNotification(`Mỗi lần chỉ được mượn tối đa ${maxBooksPerReader} cuốn sách!`, 'error'); //
                    return;
                }

                selectedBooks.push(book); //
                window.app.showNotification(`Đã chọn: ${book.title}`, 'success'); //
            }

            updateSelectedBooksDisplay(); //
            searchBook(); // Refresh search results to update selection state
        }

        // Update selected books display
        function updateSelectedBooksDisplay() {
            const container = document.getElementById('selectedBooksList'); //
            const section = document.getElementById('selectedBooksSection'); //
            const countSpan = document.getElementById('selectedBooksCount'); //

            if (selectedBooks.length === 0) {
                section.classList.add('d-none'); //
                return;
            }

            section.classList.remove('d-none'); //
            countSpan.textContent = selectedBooks.length; //

            let html = '';
            selectedBooks.forEach((book, index) => { //
                html += `
                    <div class="book-item">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${book.title}</h6>
                                <p class="mb-0">
                                    <strong>Mã:</strong> ${book.id} |
                                    <strong>Tác giả:</strong> ${window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeSelectedBook(${index})">
                                    <i class="fas fa-times"></i> Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Remove selected book
        function removeSelectedBook(index) {
            const book = selectedBooks[index]; //
            selectedBooks.splice(index, 1); //
            updateSelectedBooksDisplay(); //
            window.app.showNotification(`Đã xóa: ${book.title}`, 'info'); //

            // Refresh search results if any
            const searchTerm = document.getElementById('bookSearchInput').value.trim(); //
            if (searchTerm) {
                searchBook();
            }
        }

        // Clear selected books
        function clearSelectedBooks() {
            selectedBooks = []; //
            updateSelectedBooksDisplay(); //
            document.getElementById('bookSearchResults').innerHTML = ''; //
            document.getElementById('bookSearchInput').value = ''; //
        }

        // Process borrow
        function processBorrow() {
            if (!selectedReader) {
                window.app.showNotification('Vui lòng chọn độc giả trước!', 'error'); //
                return;
            }

            if (selectedBooks.length === 0) {
                window.app.showNotification('Vui lòng chọn ít nhất một cuốn sách!', 'error'); //
                return;
            }

            // Show confirmation modal
            showBorrowConfirmModal(); //
        }

        // Show borrow confirmation modal
        function showBorrowConfirmModal() {
            const content = document.getElementById('borrowConfirmContent'); //
            const defaultBorrowDays = window.app.getSystemSettings().maxBorrowDays || 14;

            // Set default due date based on system settings
            const today = new Date();
            const defaultDueDate = new Date();
            defaultDueDate.setDate(today.getDate() + defaultBorrowDays);
            document.getElementById('borrowDate').value = window.app.formatDate(today, 'yyyy-mm-dd');
            document.getElementById('dueDate').value = window.app.formatDate(defaultDueDate, 'yyyy-mm-dd');

            let html = `
                <div class="reader-info mb-3">
                    <h6>Thông tin độc giả</h6>
                    <p class="mb-1"><strong>Tên:</strong> ${selectedReader.fullName}</p>
                    <p class="mb-1"><strong>Mã thẻ:</strong> ${selectedReader.id}</p>
                    <p class="mb-0"><strong>Lớp:</strong> ${selectedReader.className}</p>
                </div>

                <h6>Danh sách sách mượn (${selectedBooks.length} cuốn)</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Mã sách</th>
                                <th>Tên sách</th>
                                <th>Tác giả</th>
                                <th>Thể loại</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            selectedBooks.forEach(book => { //
                const authorName = window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ';
                const categoryName = window.dataManager.getAllCategories().find(c => c.id === book.categoryId)?.name || 'Không rõ';
                html += `
                    <tr>
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${authorName}</td>
                        <td>${categoryName}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html; //

            const modal = new bootstrap.Modal(document.getElementById('borrowConfirmModal')); //
            modal.show();
        }

        // Confirm borrow
        function confirmBorrow() {
            const borrowDate = document.getElementById('borrowDate').value; //
            const dueDate = document.getElementById('dueDate').value; //
            const note = document.getElementById('borrowNote').value.trim(); //

            if (!borrowDate || !dueDate) {
                window.app.showNotification('Vui lòng chọn ngày mượn và hạn trả!', 'error'); //
                return;
            }

            if (new Date(dueDate) <= new Date(borrowDate)) {
                window.app.showNotification('Hạn trả phải sau ngày mượn!', 'error'); //
                return;
            }

            window.app.showLoading('Đang xử lý mượn sách...'); //

            setTimeout(() => {
                try {
                    // Process each book individually
                    selectedBooks.forEach(book => {
                        window.dataManager.borrowBook(
                            selectedReader.id,
                            book.id,
                            note
                        );
                    });

                    window.app.showNotification(`Mượn sách thành công cho ${selectedReader.fullName}!`, 'success'); //

                    // Generate receipt
                    generateBorrowReceipt({
                        readerId: selectedReader.id,
                        books: selectedBooks.map(book => book.id),
                        borrowDate: borrowDate,
                        dueDate: dueDate,
                        note: note
                    }); //

                    // Reset form
                    clearSelectedReader(); //
                    loadStatistics(); //

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('borrowConfirmModal')); //
                    modal.hide();

                    // Show receipt
                    setTimeout(() => {
                        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal')); //
                        receiptModal.show();
                    }, 500);

                } catch (error) {
                    window.app.showNotification(`Có lỗi xảy ra khi mượn sách: ${error.message}`, 'error'); //
                    console.error('Borrow error:', error);
                } finally {
                    window.app.hideLoading(); //
                }
            }, 1000);
        }

        // RETURN FUNCTIONS

        // Handle return reader search
        function handleReturnReaderSearch(event) {
            if (event.key === 'Enter') {
                searchReturnReader();
            }
        }

        // Search return reader
        function searchReturnReader() {
            const searchTerm = document.getElementById('returnReaderSearchInput').value.trim(); //
            if (!searchTerm) {
                window.app.showNotification('Vui lòng nhập mã thẻ hoặc tên độc giả!', 'error'); //
                return;
            }

            window.app.showLoading('Đang tìm độc giả...'); //

            setTimeout(() => {
                // Search for readers, then filter those who have borrowed books
                const readers = window.dataManager.searchReaders(searchTerm); //
                const readersWithBorrowedBooks = readers.filter(reader => getReaderBorrowedBooks(reader.id).length > 0);

                displayReturnReaderSearchResults(readersWithBorrowedBooks); //
                window.app.hideLoading(); //
            }, 500);
        }

        // Display return reader search results
        function displayReturnReaderSearchResults(readers) {
            const container = document.getElementById('returnReaderSearchResults'); //

            if (readers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Không tìm thấy độc giả nào đang mượn sách!
                    </div>
                `; //
                return;
            }

            let html = '';
            readers.forEach(reader => { //
                const borrowedBooks = getReaderBorrowedBooks(reader.id); //
                const overdueBooksCount = borrowedBooks.filter(book => isBookOverdue(book)).length; //

                html += `
                    <div class="search-result" onclick="selectReturnReader('${reader.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${reader.fullName}</h6>
                                <p class="mb-1">
                                    <strong>Mã thẻ:</strong> ${reader.id} |
                                    <strong>Lớp:</strong> ${reader.className}
                                </p>
                                <p class="mb-0">
                                    <span class="badge bg-warning">Đang mượn: ${borrowedBooks.length}</span>
                                    ${overdueBooksCount > 0 ?
                                        `<span class="badge bg-danger ms-2">Quá hạn: ${overdueBooksCount}</span>` :
                                        ''
                                    }
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-success-custom btn-sm">Chọn</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Select return reader
        function selectReturnReader(readerId) {
            const reader = window.dataManager.getReader(readerId); //
            if (!reader) return;

            selectedReturnReader = reader; //
            const borrowedBooks = getReaderBorrowedBooks(readerId); //
            selectedReturnBooks = []; // Reset selected books for return

            // Update UI
            document.getElementById('returnReaderName').textContent = reader.fullName; //
            document.getElementById('returnReaderId').textContent = reader.id; //
            document.getElementById('returnReaderClass').textContent = reader.className; //
            document.getElementById('returnReaderBorrowedCount').textContent = borrowedBooks.length; //
            document.getElementById('returnReaderOverdueCount').textContent = borrowedBooks.filter(book => isBookOverdue(book)).length; //

            document.getElementById('borrowedBooksSection').classList.remove('d-none'); //
            document.getElementById('returnReaderSearchResults').innerHTML = ''; //
            document.getElementById('returnReaderSearchInput').value = ''; //

            displayBorrowedBooks(borrowedBooks); //
            window.app.showNotification(`Đã chọn độc giả: ${reader.fullName}`, 'success'); //
        }

        // Display borrowed books for return
        function displayBorrowedBooks(borrowedBooks) {
            const container = document.getElementById('borrowedBooksList'); //

            if (borrowedBooks.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Độc giả này không có sách đang mượn.
                    </div>
                `; //
                return;
            }

            let html = '';
            borrowedBooks.forEach(borrowRecord => { //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const isOverdue = isBookOverdue(borrowRecord); //
                const isSelected = selectedReturnBooks.includes(borrowRecord.id); //
                const overdueDays = isOverdue ? calculateOverdueDays(borrowRecord.dueDate) : 0; //

                html += `
                    <div class="book-item ${isOverdue ? 'overdue' : ''} ${isSelected ? 'selected' : ''}"
                         onclick="toggleReturnBookSelection('${borrowRecord.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${book ? book.title : 'Không tìm thấy sách'}</h6>
                                <p class="mb-1">
                                    <strong>Mã sách:</strong> ${borrowRecord.bookId} |
                                    <strong>Ngày mượn:</strong> ${window.app.formatDate(borrowRecord.borrowDate)}
                                </p>
                                <p class="mb-0">
                                    <strong>Hạn trả:</strong> ${window.app.formatDate(borrowRecord.dueDate)}
                                    ${isOverdue ?
                                        `<span class="text-danger ms-2"><i class="fas fa-exclamation-triangle"></i> Quá hạn ${overdueDays} ngày</span>` :
                                        ''
                                    }
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleReturnBookSelection('${borrowRecord.id}')">
                                    <label class="form-check-label">Chọn trả</label>
                                </div>
                                ${isOverdue ?
                                    `<div class="text-danger small mt-1">Phí phạt: ${window.app.formatCurrency(overdueDays * (window.app.getSystemSettings().finePerDay || 2000))}</div>` :
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
            updateFineCalculator(); //
        }

        // Toggle return book selection
        function toggleReturnBookSelection(borrowId) {
            const index = selectedReturnBooks.indexOf(borrowId); //

            if (index >= 0) {
                selectedReturnBooks.splice(index, 1); //
            } else {
                selectedReturnBooks.push(borrowId); //
            }

            updateFineCalculator(); //

            // Update display to reflect checkbox state
            const borrowedBooks = getReaderBorrowedBooks(selectedReturnReader.id); //
            displayBorrowedBooks(borrowedBooks); //
        }

        // Update fine calculator
        function updateFineCalculator() {
            const fineCalculator = document.getElementById('fineCalculator'); //
            const finePerDay = window.app.getSystemSettings().finePerDay || 2000; //

            if (selectedReturnBooks.length === 0) {
                fineCalculator.classList.add('d-none'); //
                return;
            }

            let totalOverdueDays = 0;
            let totalFine = 0;

            selectedReturnBooks.forEach(borrowId => { //
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
                if (borrowRecord && isBookOverdue(borrowRecord)) { //
                    const overdueDays = calculateOverdueDays(borrowRecord.dueDate); //
                    totalOverdueDays += overdueDays;
                    totalFine += overdueDays * finePerDay; //
                }
            });

            if (totalFine > 0) {
                document.getElementById('overdueDays').textContent = totalOverdueDays; //
                document.getElementById('totalFine').textContent = window.app.formatCurrency(totalFine); //
                fineCalculator.classList.remove('d-none'); //
            } else {
                fineCalculator.classList.add('d-none'); //
            }
        }

        // Clear return reader
        function clearReturnReader() {
            selectedReturnReader = null; //
            selectedReturnBooks = []; //
            document.getElementById('borrowedBooksSection').classList.add('d-none'); //
            document.getElementById('fineCalculator').classList.add('d-none'); //
            document.getElementById('returnReaderSearchInput').value = ''; //
            document.getElementById('returnReaderSearchResults').innerHTML = ''; //
        }

        // Process return
        function processReturn() {
            if (!selectedReturnReader) {
                window.app.showNotification('Vui lòng chọn độc giả!', 'error'); //
                return;
            }

            if (selectedReturnBooks.length === 0) {
                window.app.showNotification('Vui lòng chọn ít nhất một cuốn sách để trả!', 'error'); //
                return;
            }

            showReturnConfirmModal(); //
        }

        // Process return with fine (same as processReturn, fine calculation happens in modal)
        function processReturnWithFine() {
            processReturn();
        }

        // Show return confirmation modal
        function showReturnConfirmModal() {
            const content = document.getElementById('returnConfirmContent'); //
            const finePerDay = window.app.getSystemSettings().finePerDay || 2000; //
            document.getElementById('returnDate').value = window.app.formatDate(new Date(), 'yyyy-mm-dd'); // Set current date

            let html = `
                <div class="reader-info mb-3">
                    <h6>Thông tin độc giả</h6>
                    <p class="mb-1"><strong>Tên:</strong> ${selectedReturnReader.fullName}</p>
                    <p class="mb-1"><strong>Mã thẻ:</strong> ${selectedReturnReader.id}</p>
                    <p class="mb-0"><strong>Lớp:</strong> ${selectedReturnReader.className}</p>
                </div>

                <h6>Danh sách sách trả (${selectedReturnBooks.length} cuốn)</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Mã sách</th>
                                <th>Tên sách</th>
                                <th>Ngày mượn</th>
                                <th>Hạn trả</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let totalFineAmount = 0;
            let totalOverdueDays = 0;

            selectedReturnBooks.forEach(borrowId => { //
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const isOverdue = isBookOverdue(borrowRecord); //
                const overdueDays = isOverdue ? calculateOverdueDays(borrowRecord.dueDate) : 0; //
                const fine = isOverdue ? overdueDays * finePerDay : 0; //

                totalFineAmount += fine;
                totalOverdueDays += overdueDays;

                html += `
                    <tr>
                        <td>${borrowRecord.bookId}</td>
                        <td>${book ? book.title : 'Không tìm thấy'}</td>
                        <td>${window.app.formatDate(borrowRecord.borrowDate)}</td>
                        <td>${window.app.formatDate(borrowRecord.dueDate)}</td>
                        <td>
                            ${isOverdue ?
                                `<span class="badge bg-danger">Quá hạn ${overdueDays} ngày</span>` :
                                `<span class="badge bg-success">Đúng hạn</span>`
                            }
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html; //

            // Update fine section
            const fineSection = document.getElementById('fineSection'); //
            // Default damage fee to 0, will be updated based on book condition input
            document.getElementById('damageFeeDisplay').textContent = window.app.formatCurrency(0); //

            if (totalFineAmount > 0) {
                document.getElementById('confirmOverdueDays').textContent = totalOverdueDays; //
                document.getElementById('confirmTotalFine').textContent = window.app.formatCurrency(totalFineAmount); //
                fineSection.classList.remove('d-none'); //
            } else {
                fineSection.classList.add('d-none'); //
            }

            const modal = new bootstrap.Modal(document.getElementById('returnConfirmModal')); //
            modal.show();

            // Add event listener to book condition select to update damage fee
            document.getElementById('bookCondition').onchange = function() {
                const condition = this.value;
                let damageFee = 0;
                if (condition === 'Kém') damageFee = 10000;
                if (condition === 'Hư hỏng') damageFee = 50000;
                document.getElementById('damageFeeDisplay').textContent = window.app.formatCurrency(damageFee);
                // Also update total fine if displayed
                document.getElementById('confirmTotalFine').textContent = window.app.formatCurrency(totalFineAmount + damageFee);
            };
        }

        // Confirm return
        function confirmReturn() {
            const returnDate = document.getElementById('returnDate').value; //
            const bookCondition = document.getElementById('bookCondition').value; //
            const note = document.getElementById('returnNote').value.trim(); //
            const damageFee = parseFloat(document.getElementById('damageFeeDisplay').textContent.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0; // Extract number from formatted currency


            if (!returnDate) {
                window.app.showNotification('Vui lòng chọn ngày trả!', 'error'); //
                return;
            }

            window.app.showLoading('Đang xử lý trả sách...'); //

            setTimeout(() => {
                let transactionSuccess = true;
                let totalFineCalculated = 0;
                const borrowedRecordsHandled = [];

                selectedReturnBooks.forEach(borrowId => { //
                    try {
                        const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId);
                        const isOverdue = isBookOverdue(borrowRecord);
                        const overdueDays = isOverdue ? calculateOverdueDays(borrowRecord.dueDate) : 0;
                        const overdueFine = overdueDays * (window.app.getSystemSettings().finePerDay || 2000);
                        totalFineCalculated += overdueFine;

                        window.dataManager.returnBook(
                            borrowId,
                            bookCondition,
                            note
                        );
                        borrowedRecordsHandled.push(borrowId);
                    } catch (error) {
                        transactionSuccess = false;
                        window.app.showNotification(`Lỗi trả sách ${borrowId}: ${error.message}`, 'error', 5000, true);
                        console.error('Error during return for record', borrowId, error);
                    }
                });

                if (transactionSuccess) {
                    window.app.showNotification(`Trả sách thành công cho ${selectedReturnReader.fullName}!`, 'success'); //

                    // Generate receipt only for successfully returned books
                    generateReturnReceipt({
                        readerId: selectedReturnReader.id,
                        borrowIds: borrowedRecordsHandled,
                        returnDate: returnDate,
                        bookCondition: bookCondition,
                        damageFee: damageFee,
                        note: note,
                        totalOverdueFine: totalFineCalculated // Pass calculated total fine
                    }); //

                    // Reset form
                    clearReturnReader(); //
                    loadStatistics(); //

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('returnConfirmModal')); //
                    modal.hide();

                    // Show receipt
                    setTimeout(() => {
                        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal')); //
                        receiptModal.show();
                    }, 500);
                } else {
                    window.app.showNotification('Có lỗi xảy ra khi trả sách. Vui lòng kiểm tra console.', 'error'); // Fallback error
                }

            } catch (error) {
                window.app.showNotification(`Lỗi xử lý trả sách: ${error.message}`, 'error');
                console.error('Confirm return error:', error);
            } finally {
                window.app.hideLoading(); //
            }
        }, 1000);

        // Quick return book
        function handleQuickReturn(event) {
            if (event.key === 'Enter') {
                quickReturnBook();
            }
        }

        function quickReturnBook() {
            const bookCode = document.getElementById('quickReturnBookCode').value.trim(); //
            if (!bookCode) {
                window.app.showNotification('Vui lòng nhập mã sách!', 'error'); //
                return;
            }

            window.app.showLoading('Đang xử lý trả sách nhanh...'); //

            setTimeout(() => {
                try {
                    const borrowRecordsForBook = window.dataManager.getAllBorrowRecords().filter(br =>
                        br.bookId === bookCode && br.status === 'borrowed'
                    );

                    if (borrowRecordsForBook.length === 0) {
                        window.app.showNotification('Không tìm thấy sách đang được mượn với mã này!', 'error'); //
                        return;
                    }

                    // If multiple copies are borrowed, pick the first one (or prompt user)
                    const borrowRecordToReturn = borrowRecordsForBook[0];
                    const reader = window.dataManager.getReader(borrowRecordToReturn.readerId); //

                    window.dataManager.returnBook(borrowRecordToReturn.id, 'Tốt', 'Trả nhanh'); // Assume 'Tốt' condition for quick return

                    window.app.showNotification(`Trả sách "${bookCode}" thành công! Độc giả: ${reader ? reader.fullName : 'Không rõ'}`, 'success'); //
                    document.getElementById('quickReturnBookCode').value = ''; // Clear input
                    loadStatistics(); //
                } catch (error) {
                    window.app.showNotification(`Lỗi trả sách nhanh: ${error.message}`, 'error'); //
                    console.error('Quick return error:', error);
                } finally {
                    window.app.hideLoading(); //
                }
            }, 500);
        }

        // RENEWAL FUNCTIONS

        // Handle renew reader search
        function handleRenewReaderSearch(event) {
            if (event.key === 'Enter') {
                searchRenewReader();
            }
        }

        // Search renew reader
        function searchRenewReader() {
            const searchTerm = document.getElementById('renewReaderSearchInput').value.trim(); //
            if (!searchTerm) {
                window.app.showNotification('Vui lòng nhập mã thẻ hoặc tên độc giả!', 'error'); //
                return;
            }

            window.app.showLoading('Đang tìm độc giả...'); //

            setTimeout(() => {
                const readers = window.dataManager.searchReaders(searchTerm); //
                const readersWithRenewableBooks = readers.filter(reader => getRenewableBooks(reader.id).length > 0); //

                displayRenewReaderSearchResults(readersWithRenewableBooks); //
                window.app.hideLoading(); //
            }, 500);
        }

        // Display renew reader search results
        function displayRenewReaderSearchResults(readers) {
            const container = document.getElementById('renewReaderSearchResults'); //

            if (readers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Không tìm thấy độc giả nào có sách có thể gia hạn!
                    </div>
                `; //
                return;
            }

            let html = '';
            readers.forEach(reader => { //
                const renewableBooks = getRenewableBooks(reader.id); //

                html += `
                    <div class="search-result" onclick="selectRenewReader('${reader.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${reader.fullName}</h6>
                                <p class="mb-1">
                                    <strong>Mã thẻ:</strong> ${reader.id} |
                                    <strong>Lớp:</strong> ${reader.className}
                                </p>
                                <p class="mb-0">
                                    <span class="badge bg-info">Có thể gia hạn: ${renewableBooks.length} sách</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-warning-custom btn-sm">Chọn</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Select renew reader
        function selectRenewReader(readerId) {
            const reader = window.dataManager.getReader(readerId); //
            if (!reader) return;

            selectedRenewReader = reader; //
            const renewableBooks = getRenewableBooks(readerId); //
            selectedRenewBooks = []; // Reset selected books for renewal

            // Update UI
            document.getElementById('renewReaderName').textContent = reader.fullName; //
            document.getElementById('renewReaderId').textContent = reader.id; //
            document.getElementById('renewReaderClass').textContent = reader.className; //
            document.getElementById('renewableCount').textContent = renewableBooks.length; //

            document.getElementById('renewableBooksSection').classList.remove('d-none'); //
            document.getElementById('renewReaderSearchResults').innerHTML = ''; //
            document.getElementById('renewReaderSearchInput').value = ''; //

            displayRenewableBooks(renewableBooks); //
            window.app.showNotification(`Đã chọn độc giả: ${reader.fullName}`, 'success'); //
        }

        // Get books that are currently borrowed and can be renewed
        function getRenewableBooks(readerId) {
            const borrowedBooks = window.dataManager.getBorrowRecords({ readerId: readerId, status: 'borrowed' }); //
            const maxRenewals = window.app.getSystemSettings().maxRenewals || 2; //
            const hasUnpaidFines = window.dataManager.getFines({ readerId: readerId, status: 'unpaid' }).length > 0; //

            return borrowedBooks.filter(borrowRecord => { //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const isOverdue = isBookOverdue(borrowRecord); //
                const isReservedByOthers = window.dataManager.getAllReservations().some(r =>
                    r.bookId === borrowRecord.bookId && r.readerId !== readerId && r.status === 'active'
                );

                return (
                    borrowRecord.renewalCount < maxRenewals && // Within renewal limit
                    !isOverdue && // Not overdue
                    !isReservedByOthers && // Not reserved by others
                    !hasUnpaidFines // Reader has no unpaid fines
                );
            });
        }


        // Display renewable books
        function displayRenewableBooks(renewableBooks) {
            const container = document.getElementById('renewableBooksList'); //
            const maxRenewals = window.app.getSystemSettings().maxRenewals || 2; //

            if (renewableBooks.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Độc giả này không có sách có thể gia hạn.
                    </div>
                `; //
                return;
            }

            let html = '';
            renewableBooks.forEach(borrowRecord => { //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const isSelected = selectedRenewBooks.includes(borrowRecord.id); //
                const renewCount = borrowRecord.renewalCount || 0; //
                const canRenew = renewCount < maxRenewals; //

                html += `
                    <div class="book-item ${isSelected ? 'selected' : ''} ${!canRenew ? 'border-warning' : ''}"
                         onclick="toggleRenewBookSelection('${borrowRecord.id}')">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${book ? book.title : 'Không tìm thấy sách'}</h6>
                                <p class="mb-1">
                                    <strong>Mã sách:</strong> ${borrowRecord.bookId} |
                                    <strong>Hạn trả:</strong> ${window.app.formatDate(borrowRecord.dueDate)}
                                </p>
                                <p class="mb-0">
                                    <strong>Đã gia hạn:</strong> ${renewCount}/${maxRenewals} lần
                                    ${!canRenew ?
                                        `<span class="text-warning ms-2"><i class="fas fa-exclamation-triangle"></i> Đã hết lượt gia hạn</span>` :
                                        ''
                                    }
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           ${isSelected ? 'checked' : ''}
                                           ${!canRenew ? 'disabled' : ''}
                                           onchange="toggleRenewBookSelection('${borrowRecord.id}')">
                                    <label class="form-check-label">Chọn gia hạn</label>
                                </div>
                                <div class="text-info small mt-1">Phí: ${window.app.formatCurrency(5000)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html; //
        }

        // Toggle renew book selection
        function toggleRenewBookSelection(borrowId) {
            const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
            const maxRenewals = window.app.getSystemSettings().maxRenewals || 2; //
            const renewCount = borrowRecord.renewalCount || 0; //

            if (renewCount >= maxRenewals) {
                window.app.showNotification('Sách này đã hết lượt gia hạn!', 'error'); //
                return;
            }

            const index = selectedRenewBooks.indexOf(borrowId); //

            if (index >= 0) {
                selectedRenewBooks.splice(index, 1); //
            } else {
                selectedRenewBooks.push(borrowId); //
            }

            // Update display to reflect checkbox state
            const renewableBooks = getRenewableBooks(selectedRenewReader.id); //
            displayRenewableBooks(renewableBooks); //
        }

        // Clear renew reader
        function clearRenewReader() {
            selectedRenewReader = null; //
            selectedRenewBooks = []; //
            document.getElementById('renewableBooksSection').classList.add('d-none'); //
            document.getElementById('renewReaderSearchInput').value = ''; //
            document.getElementById('renewReaderSearchResults').innerHTML = ''; //
        }

        // Process renewal
        function processRenewal() {
            if (!selectedRenewReader) {
                window.app.showNotification('Vui lòng chọn độc giả!', 'error'); //
                return;
            }

            if (selectedRenewBooks.length === 0) {
                window.app.showNotification('Vui lòng chọn ít nhất một cuốn sách để gia hạn!', 'error'); //
                return;
            }

            showRenewConfirmModal(); //
        }

        // Renew all books
        function renewAllBooks() {
            if (!selectedRenewReader) {
                window.app.showNotification('Vui lòng chọn độc giả!', 'error'); //
                return;
            }

            const renewableBooks = getRenewableBooks(selectedRenewReader.id); //
            selectedRenewBooks = renewableBooks
                .filter(book => (book.renewalCount || 0) < (window.app.getSystemSettings().maxRenewals || 2))
                .map(book => book.id); //

            if (selectedRenewBooks.length === 0) {
                window.app.showNotification('Không có sách nào có thể gia hạn!', 'error'); //
                return;
            }

            displayRenewableBooks(renewableBooks); // Update display
            showRenewConfirmModal(); //
        }

        // Show renew confirmation modal
        function showRenewConfirmModal() {
            const content = document.getElementById('renewConfirmContent'); //
            const maxBorrowDays = window.app.getSystemSettings().maxBorrowDays || 14; //
            const renewalFeePerBook = 5000; // Fixed renewal fee

            let html = `
                <div class="reader-info mb-3">
                    <h6>Thông tin độc giả</h6>
                    <p class="mb-1"><strong>Tên:</strong> ${selectedRenewReader.fullName}</p>
                    <p class="mb-1"><strong>Mã thẻ:</strong> ${selectedRenewReader.id}</p>
                    <p class="mb-0"><strong>Lớp:</strong> ${selectedRenewReader.className}</p>
                </div>

                <h6>Danh sách sách gia hạn (${selectedRenewBooks.length} cuốn)</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Mã sách</th>
                                <th>Tên sách</th>
                                <th>Hạn trả hiện tại</th>
                                <th>Hạn trả mới</th>
                                <th>Phí gia hạn</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let totalFee = 0;
            let firstCurrentDue = null;
            let firstNewDue = null;

            selectedRenewBooks.forEach(borrowId => { //
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const currentDue = new Date(borrowRecord.dueDate); // Use dueDate for current due date
                const newDue = new Date(currentDue);
                newDue.setDate(newDue.getDate() + maxBorrowDays); // Extend by maxBorrowDays

                if (!firstCurrentDue) {
                    firstCurrentDue = window.app.formatDate(borrowRecord.dueDate, 'yyyy-mm-dd');
                    firstNewDue = window.app.formatDate(newDue, 'yyyy-mm-dd');
                }

                totalFee += renewalFeePerBook; //

                html += `
                    <tr>
                        <td>${borrowRecord.bookId}</td>
                        <td>${book ? book.title : 'Không tìm thấy'}</td>
                        <td>${window.app.formatDate(borrowRecord.dueDate)}</td>
                        <td>${window.app.formatDate(newDue)}</td>
                        <td>${window.app.formatCurrency(renewalFeePerBook)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="table-warning">
                                <th colspan="4">Tổng phí gia hạn:</th>
                                <th>${window.app.formatCurrency(totalFee)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            content.innerHTML = html; //

            // Set dates
            document.getElementById('currentDueDate').value = firstCurrentDue; //
            document.getElementById('newDueDate').value = firstNewDue; //
            document.getElementById('renewalFee').value = window.app.formatCurrency(totalFee); //

            const modal = new bootstrap.Modal(document.getElementById('renewConfirmModal')); //
            modal.show();
        }

        // Confirm renewal
        function confirmRenewal() {
            const reason = document.getElementById('renewalReason').value.trim(); //

            if (!reason) {
                window.app.showNotification('Vui lòng nhập lý do gia hạn!', 'error'); //
                return;
            }

            window.app.showLoading('Đang xử lý gia hạn...'); //

            setTimeout(() => {
                let transactionSuccess = true;
                const renewedBorrowIds = [];

                selectedRenewBooks.forEach(borrowId => { //
                    try {
                        window.dataManager.renewBook(
                            borrowId,
                            reason
                        );
                        renewedBorrowIds.push(borrowId);
                    } catch (error) {
                        transactionSuccess = false;
                        window.app.showNotification(`Lỗi gia hạn sách ${borrowId}: ${error.message}`, 'error', 5000, true);
                        console.error('Error during renewal for record', borrowId, error);
                    }
                });

                if (transactionSuccess) {
                    window.app.showNotification(`Gia hạn thành công cho ${selectedRenewReader.fullName}!`, 'success'); //

                    // Generate receipt
                    generateRenewalReceipt({
                        readerId: selectedRenewReader.id,
                        borrowIds: renewedBorrowIds,
                        reason: reason,
                        renewalDate: new Date().toISOString().split('T')[0]
                    }); //

                    // Reset form
                    clearRenewReader(); //
                    loadStatistics(); //

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('renewConfirmModal')); //
                    modal.hide();

                    // Show receipt
                    setTimeout(() => {
                        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal')); //
                        receiptModal.show();
                    }, 500);
                } else {
                    window.app.showNotification('Có lỗi xảy ra khi gia hạn sách. Vui lòng kiểm tra console.', 'error'); // Fallback error
                }

            } catch (error) {
                window.app.showNotification(`Lỗi xử lý gia hạn: ${error.message}`, 'error');
                console.error('Confirm renewal error:', error);
            } finally {
                window.app.hideLoading(); //
            }
        }, 1000);

        // SEARCH FUNCTIONS

        // Perform advanced search
        function performAdvancedSearch() {
            const searchType = document.getElementById('searchType').value; //
            const keyword = document.getElementById('searchKeyword').value.trim(); //
            const fromDate = document.getElementById('searchFromDate').value; //
            const toDate = document.getElementById('searchToDate').value; //
            const status = document.getElementById('searchStatus').value; //
            const className = document.getElementById('searchClass').value; //

            if (!keyword && !fromDate && !toDate && !status && !className) {
                window.app.showNotification('Vui lòng nhập ít nhất một tiêu chí tìm kiếm!', 'error'); //
                return;
            }

            window.app.showLoading('Đang tìm kiếm...'); //

            setTimeout(() => {
                const searchCriteria = {
                    searchReaders: searchType === 'reader',
                    searchBooks: searchType === 'book',
                    searchBorrows: searchType === 'transaction',
                    searchTerm: keyword,
                    fromDate: fromDate,
                    toDate: toDate,
                    readerStatus: searchType === 'reader' ? status : undefined, // Status for reader search
                    bookStatus: searchType === 'book' ? status : undefined, // Status for book search
                    borrowStatus: searchType === 'transaction' ? status : undefined, // Status for transaction search
                    className: className
                };

                const results = window.dataManager.advancedSearch(searchCriteria); //

                // Combine results into a single array for display, depending on searchType
                currentSearchResults = [];
                if (searchType === 'reader') {
                    currentSearchResults = results.readers;
                } else if (searchType === 'book') {
                    currentSearchResults = results.books;
                } else if (searchType === 'transaction') {
                    currentSearchResults = results.borrowRecords;
                }

                currentSearchPage = 1; // Reset to first page
                displaySearchResults(currentSearchResults, searchType); //
                window.app.hideLoading(); //
            }, 1000);
        }

        // Display search results in table
        function displaySearchResults(results, searchType) {
            const section = document.getElementById('searchResultsSection'); //
            const header = document.getElementById('searchResultsHeader'); //
            const body = document.getElementById('searchResultsBody'); //
            const count = document.getElementById('searchResultsCount'); //
            const paginationContainer = document.getElementById('searchPagination'); //

            count.textContent = results.length; //
            section.classList.remove('d-none'); //

            if (results.length === 0) {
                body.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không tìm thấy kết quả nào</p>
                        </td>
                    </tr>
                `; //
                paginationContainer.innerHTML = ''; //
                return;
            }

            // Generate header based on search type
            let headerHtml = '';
            switch (searchType) {
                case 'reader':
                    headerHtml = `
                        <tr>
                            <th>Mã thẻ</th>
                            <th>Họ tên</th>
                            <th>Lớp</th>
                            <th>Đang mượn</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    `; //
                    break;
                case 'book':
                    headerHtml = `
                        <tr>
                            <th>Mã sách</th>
                            <th>Tên sách</th>
                            <th>Tác giả</th>
                            <th>Thể loại</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    `; //
                    break;
                case 'transaction':
                    headerHtml = `
                        <tr>
                            <th>Ngày</th>
                            <th>Độc giả</th>
                            <th>Sách</th>
                            <th>Loại giao dịch</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    `; //
                    break;
            }
            header.innerHTML = headerHtml; //

            // Paginate and display results
            const paginatedResults = window.app.paginateData(results, currentSearchPage, searchItemsPerPage); //
            let bodyHtml = '';

            paginatedResults.data.forEach(item => { //
                switch (searchType) {
                    case 'reader':
                        const borrowedCount = getReaderBorrowedBooks(item.id).length; //
                        const readerStatus = getReaderDisplayStatus(item); //
                        bodyHtml += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.fullName}</td>
                                <td>${item.className}</td>
                                <td><span class="badge bg-warning">${borrowedCount}</span></td>
                                <td><span class="status-badge ${readerStatus.class}">${readerStatus.text}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewReaderDetail('${item.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="selectReaderForBorrow('${item.id}')">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                        `; //
                        break;
                    case 'book':
                        const availableCopies = item.availableCopies; //
                        const bookDisplayStatus = item.availableCopies > 0 ? 'Có sẵn' : 'Hết sách';
                        const bookStatusClass = item.availableCopies > 0 ? 'bg-success' : 'bg-danger';
                        const authorName = window.dataManager.getAllAuthors().find(a => a.id === item.authorId)?.name || 'Không rõ';
                        const categoryName = window.dataManager.getAllCategories().find(c => c.id === item.categoryId)?.name || 'Không rõ';

                        bodyHtml += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.title}</td>
                                <td>${authorName}</td>
                                <td>${categoryName}</td>
                                <td>
                                    <span class="badge ${bookStatusClass}">
                                        ${bookDisplayStatus} (${availableCopies}/${item.totalCopies})
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewBookDetail('${item.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${availableCopies > 0 ?
                                        `<button class="btn btn-sm btn-outline-success" onclick="selectBookForBorrow('${item.id}')">
                                            <i class="fas fa-plus"></i>
                                        </button>` : ''
                                    }
                                </td>
                            </tr>
                        `; //
                        break;
                    case 'transaction':
                        const reader = window.dataManager.getReader(item.readerId); //
                        const book = window.dataManager.getBook(item.bookId); //
                        const transactionStatus = getTransactionDisplayStatus(item); //
                        bodyHtml += `
                            <tr>
                                <td>${window.app.formatDate(item.borrowDate || item.returnDate || item.renewalDate)}</td>
                                <td>${reader ? reader.fullName : 'Không tìm thấy'}</td>
                                <td>${book ? book.title : 'Không tìm thấy'}</td>
                                <td>
                                    <span class="badge ${getTransactionTypeBadge(item.loaiGiaoDich || (item.returnDate ? 'return' : (item.renewalDate ? 'renew' : 'borrow')))}">
                                        ${getTransactionTypeText(item.loaiGiaoDich || (item.returnDate ? 'return' : (item.renewalDate ? 'renew' : 'borrow')))}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${transactionStatus.class}">
                                        ${transactionStatus.text}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetail('${item.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="printTransactionReceipt('${item.id}')">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </td>
                            </tr>
                        `; //
                        break;
                }
            });

            body.innerHTML = bodyHtml; //
            updateSearchPagination(paginatedResults.totalPages); //
        }

        // Update search results pagination
        function updateSearchPagination(totalPages) {
            const pagination = document.getElementById('searchPagination'); //

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            // Previous button
            html += `
                <li class="page-item ${currentSearchPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeSearchPage(${currentSearchPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentSearchPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeSearchPage(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${currentSearchPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeSearchPage(${currentSearchPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            pagination.innerHTML = html;
        }

        // Change search page
        function changeSearchPage(page) {
            const totalPages = Math.ceil(currentSearchResults.length / searchItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentSearchPage = page;
                const searchType = document.getElementById('searchType').value;
                displaySearchResults(currentSearchResults, searchType);
            }
        }

        // Clear search form
        function clearSearchForm() {
            document.getElementById('searchKeyword').value = ''; //
            document.getElementById('searchFromDate').value = ''; //
            document.getElementById('searchToDate').value = ''; //
            document.getElementById('searchStatus').value = ''; //
            document.getElementById('searchClass').value = ''; //
            document.getElementById('searchResultsSection').classList.add('d-none'); //
            currentSearchResults = []; //
            currentSearchPage = 1; //
            document.getElementById('searchPagination').innerHTML = ''; //
        }

        // Export search results
        function exportSearchResults() {
            if (currentSearchResults.length === 0) {
                window.app.showNotification('Không có dữ liệu để xuất!', 'error'); //
                return;
            }

            window.app.showLoading('Đang xuất kết quả tìm kiếm...'); //

            setTimeout(() => {
                const searchType = document.getElementById('searchType').value; //
                const csvContent = generateSearchResultsCSV(currentSearchResults, searchType); //
                window.app.downloadFile(csvContent, `ket-qua-tim-kiem-${searchType}-${window.app.formatDate(new Date(), 'yyyy-mm-dd')}.csv`, 'text/csv;charset=utf-8;'); //
                window.app.showNotification('Xuất dữ liệu thành công!', 'success'); //
                window.app.hideLoading(); //
            }, 1000);
        }

        // Quick search functions
        function showTodayTransactions() {
            const today = window.app.formatDate(new Date(), 'yyyy-mm-dd'); //
            document.getElementById('searchType').value = 'transaction'; //
            document.getElementById('searchFromDate').value = today; //
            document.getElementById('searchToDate').value = today; //
            performAdvancedSearch(); //
        }

        function showOverdueBooksQuick() {
            document.getElementById('searchType').value = 'transaction'; //
            document.getElementById('searchStatus').value = 'overdue'; //
            performAdvancedSearch(); //
        }

        function showPopularBooksQuick() {
            window.app.showLoading('Đang tải sách phổ biến...'); //
            setTimeout(() => {
                const popularBooks = window.dataManager.getPopularBooks(20); // Get top 20 popular books
                currentSearchResults = popularBooks.map(item => item.book); // Map to book objects
                const searchType = 'book';
                displaySearchResults(currentSearchResults, searchType); //
                window.app.hideLoading(); //
            }, 500);
        }

        function showActiveReadersQuick() {
            window.app.showLoading('Đang tải độc giả tích cực...'); //
            setTimeout(() => {
                const activeReaders = window.dataManager.getActiveReaders(30); // Active in last 30 days
                currentSearchResults = activeReaders; //
                const searchType = 'reader';
                displaySearchResults(currentSearchResults, searchType); //
                window.app.hideLoading(); //
            }, 500);
        }

        // MODAL FUNCTIONS

        // Show borrow history modal
        function showBorrowHistoryModal() {
            loadBorrowHistory(); //
            const modal = new bootstrap.Modal(document.getElementById('borrowHistoryModal')); //
            modal.show();
        }

        // Load borrow history
        function loadBorrowHistory() {
            const filter = document.getElementById('historyFilter').value; //
            const type = document.getElementById('historyType').value; //
            const searchKeyword = document.getElementById('historySearch').value.trim(); //

            let filteredHistory = window.dataManager.getAllBorrowRecords(); // Get all records

            // Apply date range filter
            const today = new Date();
            const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);

            switch (filter) {
                case 'today':
                    filteredHistory = filteredHistory.filter(record => {
                        const recordDate = record.borrowDate || record.returnDate || record.renewalDate;
                        return recordDate >= startOfToday && recordDate <= endOfToday;
                    });
                    break;
                case 'week':
                    const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay())); // Sunday
                    startOfWeek.setHours(0,0,0,0);
                    filteredHistory = filteredHistory.filter(record => {
                        const recordDate = record.borrowDate || record.returnDate || record.renewalDate;
                        return recordDate >= startOfWeek;
                    });
                    break;
                case 'month':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    filteredHistory = filteredHistory.filter(record => {
                        const recordDate = record.borrowDate || record.returnDate || record.renewalDate;
                        return recordDate >= startOfMonth;
                    });
                    break;
            }

            // Apply transaction type filter
            if (type !== 'all') {
                filteredHistory = filteredHistory.filter(record => {
                    const recordType = record.returnDate ? 'return' : (record.renewalDate ? 'renew' : 'borrow');
                    return recordType === type;
                });
            }

            // Apply search keyword filter (on reader name or book title/id)
            if (searchKeyword) {
                const lowerCaseKeyword = window.app.removeAccents(searchKeyword.toLowerCase());
                filteredHistory = filteredHistory.filter(record => {
                    const reader = window.dataManager.getReader(record.readerId);
                    const book = window.dataManager.getBook(record.bookId);
                    const readerName = reader ? window.app.removeAccents(reader.fullName.toLowerCase()) : '';
                    const bookTitle = book ? window.app.removeAccents(book.title.toLowerCase()) : '';
                    const bookId = window.app.removeAccents(record.bookId.toLowerCase());

                    return readerName.includes(lowerCaseKeyword) ||
                           bookTitle.includes(lowerCaseKeyword) ||
                           bookId.includes(lowerCaseKeyword);
                });
            }
            filteredHistory.sort((a,b) => (b.borrowDate || b.returnDate || b.renewalDate) - (a.borrowDate || a.returnDate || a.renewalDate));

            displayBorrowHistory(filteredHistory); //
        }

        // Display borrow history
        function displayBorrowHistory(history) {
            const tbody = document.getElementById('historyTableBody'); //

            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không có lịch sử giao dịch</p>
                        </td>
                    </tr>
                `; //
                return;
            }

            let html = '';
            history.forEach(record => { //
                const reader = window.dataManager.getReader(record.readerId); //
                const book = window.dataManager.getBook(record.bookId); //
                const transactionStatus = getTransactionDisplayStatus(record); //
                const transactionType = record.returnDate ? 'return' : (record.renewalDate ? 'renew' : 'borrow');

                html += `
                    <tr>
                        <td>${window.app.formatDateTime(record.borrowDate || record.returnDate || record.renewalDate)}</td>
                        <td>
                            <strong>${reader ? reader.fullName : 'Không tìm thấy'}</strong><br>
                            <small class="text-muted">${record.readerId}</small>
                        </td>
                        <td>
                            <strong>${book ? book.title : 'Không tìm thấy'}</strong><br>
                            <small class="text-muted">${record.bookId}</small>
                        </td>
                        <td>
                            <span class="badge ${getTransactionTypeBadge(transactionType)}">
                                ${getTransactionTypeText(transactionType)}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${transactionStatus.class}">
                                ${transactionStatus.text}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetail('${record.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="printTransactionReceipt('${record.id}')">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html; //
        }

        // Filter history (already called in loadBorrowHistory)
        function filterHistory() {
            loadBorrowHistory();
        }

        // Export history
        function exportHistory() {
            window.app.showLoading('Đang xuất lịch sử mượn/trả...'); //

            setTimeout(() => {
                const history = loadBorrowHistory(); // Get filtered history data
                const csvContent = generateHistoryCSV(history); //
                window.app.downloadFile(csvContent, `lich-su-muon-tra-${window.app.formatDate(new Date(), 'yyyy-mm-dd')}.csv`, 'text/csv;charset=utf-8;'); //
                window.app.showNotification('Xuất lịch sử thành công!', 'success'); //
                window.app.hideLoading(); //
            }, 1000);
        }

        // Generate CSV content for history
        function generateHistoryCSV(historyToExport) {
            const headers = [
                'ID Giao dịch', 'Mã độc giả', 'Tên độc giả', 'Lớp',
                'Mã sách', 'Tên sách', 'Tác giả', 'Loại giao dịch',
                'Ngày mượn', 'Hạn trả', 'Ngày trả/gia hạn', 'Trạng thái', 'Ghi chú'
            ];

            const rows = historyToExport.map(record => {
                const reader = window.dataManager.getReader(record.readerId);
                const book = window.dataManager.getBook(record.bookId);
                const transactionType = record.returnDate ? 'return' : (record.renewalDate ? 'renew' : 'borrow');

                return [
                    record.id,
                    record.readerId,
                    reader ? reader.fullName : 'Không tìm thấy',
                    reader ? reader.className : 'Không tìm thấy',
                    record.bookId,
                    book ? book.title : 'Không tìm thấy',
                    book ? (window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ') : 'Không tìm thấy',
                    getTransactionTypeText(transactionType),
                    window.app.formatDate(record.borrowDate),
                    window.app.formatDate(record.dueDate),
                    record.returnDate ? window.app.formatDate(record.returnDate) : (record.renewalDate ? window.app.formatDate(record.renewalDate) : ''),
                    getTransactionDisplayStatus(record).text,
                    record.notes || ''
                ];
            });

            return [headers, ...rows].map(row =>
                row.map(field => {
                    const stringField = String(field);
                    if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                        return '"' + stringField.replace(/"/g, '""') + '"';
                    }
                    return stringField;
                }).join(',')
            ).join('\n');
        }


        // Show overdue modal
        function showOverdueModal() {
            loadOverdueBooks(); //
            const modal = new bootstrap.Modal(document.getElementById('overdueModal')); //
            modal.show();
        }

        // Load overdue books
        function loadOverdueBooks() {
            const filter = document.getElementById('overdueFilter').value; //
            const searchKeyword = document.getElementById('overdueSearch').value.trim(); //

            let overdueBooks = window.dataManager.getOverdueBooks(); // Get all overdue records

            // Apply filter based on overdue days
            overdueBooks = overdueBooks.filter(record => {
                const days = record.overdueDays;
                switch (filter) {
                    case '1-7': return days >= 1 && days <= 7;
                    case '8-14': return days >= 8 && days <= 14;
                    case '15-30': return days >= 15 && days <= 30;
                    case '30+': return days > 30;
                    default: return true; // 'all'
                }
            });

            // Apply search keyword filter
            if (searchKeyword) {
                const lowerCaseKeyword = window.app.removeAccents(searchKeyword.toLowerCase());
                overdueBooks = overdueBooks.filter(record => {
                    const readerName = record.reader ? window.app.removeAccents(record.reader.fullName.toLowerCase()) : '';
                    const bookTitle = record.book ? window.app.removeAccents(record.book.title.toLowerCase()) : '';
                    return readerName.includes(lowerCaseKeyword) || bookTitle.includes(lowerCaseKeyword);
                });
            }

            displayOverdueBooks(overdueBooks); //
        }

        // Display overdue books
        function displayOverdueBooks(overdueBooks) {
            const tbody = document.getElementById('overdueTableBody'); //

            if (overdueBooks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p class="text-success">Không có sách quá hạn!</p>
                        </td>
                    </tr>
                `; //
                return;
            }

            let html = '';
            overdueBooks.forEach(record => { //
                const reader = record.reader; // already populated in getOverdueBooks result
                const book = record.book; // already populated in getOverdueBooks result
                const fine = record.fineAmount; // already populated in getOverdueBooks result

                html += `
                    <tr>
                        <td>
                            <strong>${reader ? reader.fullName : 'Không tìm thấy'}</strong><br>
                            <small class="text-muted">${record.readerId} - ${reader ? reader.className : ''}</small>
                        </td>
                        <td>
                            <strong>${book ? book.title : 'Không tìm thấy'}</strong><br>
                            <small class="text-muted">${record.bookId}</small>
                        </td>
                        <td>${window.app.formatDate(record.borrowDate)}</td>
                        <td>${window.app.formatDate(record.dueDate)}</td>
                        <td>
                            <span class="badge bg-danger">${record.overdueDays} ngày</span>
                        </td>
                        <td>
                            <strong class="text-danger">${window.app.formatCurrency(fine)}</strong>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="processOverdueReturn('${record.id}')">
                                <i class="fas fa-undo"></i> Trả
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="sendSingleOverdueNotification('${record.readerId}')">
                                <i class="fas fa-bell"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html; //
        }

        // Send overdue notifications (bulk)
        function sendOverdueNotifications() {
            window.app.showLoading('Đang gửi thông báo quá hạn...'); //

            setTimeout(() => {
                const overdueBooks = window.dataManager.getOverdueBooks(); // Get all overdue records
                let notificationsSent = 0;
                overdueBooks.forEach(record => {
                    // Simulate sending notification (e.g., email/SMS)
                    const reader = record.reader;
                    const book = record.book;
                    if (reader && book) {
                         window.app.showNotification(`Đã gửi thông báo quá hạn cho ${reader.fullName} về sách ${book.title}.`, 'info', 3000); // Simulate individual notification
                         window.app.logActivity('send_overdue_notification', `Gửi thông báo quá hạn cho ${reader.fullName} về sách ${book.title}`, { readerId: reader.id, bookId: book.id });
                         notificationsSent++;
                    }
                });

                if (notificationsSent > 0) {
                     window.app.showNotification(`Đã gửi ${notificationsSent} thông báo quá hạn!`, 'success'); //
                } else {
                     window.app.showNotification('Không có sách quá hạn nào để gửi thông báo.', 'info');
                }
                window.app.hideLoading(); //
            }, 1500);
        }

        // Send single overdue notification
        function sendSingleOverdueNotification(readerId) {
            window.app.showLoading('Đang gửi thông báo...'); //

            setTimeout(() => {
                const reader = window.dataManager.getReader(readerId); //
                const overdueBooks = window.dataManager.getOverdueBooks().filter(br => br.readerId === readerId); //
                if (reader && overdueBooks.length > 0) {
                    const bookTitles = overdueBooks.map(br => br.book ? br.book.title : br.bookId).join(', ');
                    window.app.showNotification(`Đã gửi thông báo quá hạn cho ${reader.fullName} về các sách: ${bookTitles}.`, 'success'); //
                    window.app.logActivity('send_overdue_notification', `Gửi thông báo quá hạn riêng lẻ cho ${reader.fullName} về các sách: ${bookTitles}`, { readerId: reader.id, overdueBooks: overdueBooks.map(b => b.bookId) });
                } else {
                    window.app.showNotification('Không tìm thấy độc giả hoặc không có sách quá hạn.', 'error'); //
                }
                window.app.hideLoading(); //
            }, 500);
        }

        // Process overdue return (pre-fills return modal)
        function processOverdueReturn(borrowId) {
            const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
            const reader = window.dataManager.getReader(borrowRecord.readerId); //

            // Auto-select reader and book for return
            selectedReturnReader = reader; //
            selectedReturnBooks = [borrowId]; //

            // Switch to return tab
            const returnTab = new bootstrap.Tab(document.getElementById('return-tab')); //
            returnTab.show();

            // Close overdue modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('overdueModal')); //
            modal.hide();

            // Show return confirmation after a short delay
            setTimeout(() => {
                showReturnConfirmModal(); //
            }, 500);
        }

        // Export overdue list
        function exportOverdueList() {
            window.app.showLoading('Đang xuất danh sách quá hạn...'); //

            setTimeout(() => {
                const overdueBooks = loadOverdueBooks(); // Get currently filtered overdue books
                const csvContent = generateOverdueCSV(overdueBooks); //
                window.app.downloadFile(csvContent, `danh-sach-qua-han-${window.app.formatDate(new Date(), 'yyyy-mm-dd')}.csv`, 'text/csv;charset=utf-8;'); //
                window.app.showNotification('Xuất danh sách quá hạn thành công!', 'success'); //
                window.app.hideLoading(); //
            }, 1000);
        }

        // Generate CSV for overdue list
        function generateOverdueCSV(overdueList) {
            const headers = [
                'ID Giao dịch', 'Mã độc giả', 'Tên độc giả', 'Lớp',
                'Mã sách', 'Tên sách', 'Tác giả',
                'Ngày mượn', 'Hạn trả', 'Số ngày quá hạn', 'Phí phạt'
            ];

            const rows = overdueList.map(record => {
                const reader = record.reader; // Already populated
                const book = record.book; // Already populated
                const author = book ? (window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ') : 'Không tìm thấy';

                return [
                    record.id,
                    record.readerId,
                    reader ? reader.fullName : 'Không tìm thấy',
                    reader ? reader.className : 'Không tìm thấy',
                    record.bookId,
                    book ? book.title : 'Không tìm thấy',
                    author,
                    window.app.formatDate(record.borrowDate),
                    window.app.formatDate(record.dueDate),
                    record.overdueDays,
                    record.fineAmount
                ];
            });

            return [headers, ...rows].map(row =>
                row.map(field => {
                    const stringField = String(field);
                    if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                        return '"' + stringField.replace(/"/g, '""') + '"';
                    }
                    return stringField;
                }).join(',')
            ).join('\n');
        }


        // RECEIPT FUNCTIONS

        // Generate borrow receipt
        function generateBorrowReceipt(borrowData) {
            const reader = window.dataManager.getReader(borrowData.readerId); //
            const receiptContent = document.getElementById('receiptContent'); //

            let html = `
                <div class="receipt-header">
                    <h4>PHIẾU MƯỢN SÁCH</h4>
                    <p class="mb-0">Thư viện trường THPT ABC</p>
                    <small>Ngày: ${window.app.formatDateTime(new Date())}</small>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Độc giả:</strong> ${reader ? reader.fullName : 'Không tìm thấy'}<br>
                        <strong>Mã thẻ:</strong> ${borrowData.readerId}<br>
                        <strong>Lớp:</strong> ${reader ? reader.className : 'Không tìm thấy'}
                    </div>
                    <div class="col-6">
                        <strong>Ngày mượn:</strong> ${window.app.formatDate(borrowData.borrowDate)}<br>
                        <strong>Hạn trả:</strong> ${window.app.formatDate(borrowData.dueDate)}<br>
                        <strong>Thủ thư:</strong> ${window.app.currentUser?.name || 'Admin'}
                    </div>
                </div>

                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã sách</th>
                            <th>Tên sách</th>
                            <th>Tác giả</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            borrowData.books.forEach((bookId, index) => { //
                const book = window.dataManager.getBook(bookId); //
                const authorName = book ? (window.dataManager.getAllAuthors().find(a => a.id === book.authorId)?.name || 'Không rõ') : 'Không tìm thấy';
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${bookId}</td>
                        <td>${book ? book.title : 'Không tìm thấy'}</td>
                        <td>${authorName}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <div class="mt-3">
                    <p><strong>Tổng số sách:</strong> ${borrowData.books.length} cuốn</p>
                    ${borrowData.note ? `<p><strong>Ghi chú:</strong> ${borrowData.note}</p>` : ''}
                </div>

                <div class="row mt-4">
                    <div class="col-6 text-center">
                        <strong>Độc giả</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                    <div class="col-6 text-center">
                        <strong>Thủ thư</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                </div>
            `;

            receiptContent.innerHTML = html; //
        }

        // Generate return receipt
        function generateReturnReceipt(returnData) {
            const reader = window.dataManager.getReader(returnData.readerId); //
            const receiptContent = document.getElementById('receiptContent'); //
            const finePerDay = window.app.getSystemSettings().finePerDay || 2000; //

            let totalOverdueFine = 0; // Calculated during return process
            let totalDamageFee = returnData.damageFee || 0;

            let html = `
                <div class="receipt-header">
                    <h4>PHIẾU TRẢ SÁCH</h4>
                    <p class="mb-0">Thư viện trường THPT ABC</p>
                    <small>Ngày: ${window.app.formatDateTime(new Date())}</small>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Độc giả:</strong> ${reader ? reader.fullName : 'Không tìm thấy'}<br>
                        <strong>Mã thẻ:</strong> ${returnData.readerId}<br>
                        <strong>Lớp:</strong> ${reader ? reader.className : 'Không tìm thấy'}
                    </div>
                    <div class="col-6">
                        <strong>Ngày trả:</strong> ${window.app.formatDate(returnData.returnDate)}<br>
                        <strong>Tình trạng sách:</strong> ${returnData.bookCondition}<br>
                        <strong>Thủ thư:</strong> ${window.app.currentUser?.name || 'Admin'}
                    </div>
                </div>

                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã sách</th>
                            <th>Tên sách</th>
                            <th>Hạn trả</th>
                            <th>Phí phạt (quá hạn)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            returnData.borrowIds.forEach((borrowId, index) => { //
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const isOverdue = isBookOverdue(borrowRecord); //
                const overdueDays = isOverdue ? calculateOverdueDays(borrowRecord.dueDate) : 0; //
                const fine = isOverdue ? overdueDays * finePerDay : 0; //
                totalOverdueFine += fine;

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${borrowRecord.bookId}</td>
                        <td>${book ? book.title : 'Không tìm thấy'}</td>
                        <td>${window.app.formatDate(borrowRecord.dueDate)}</td>
                        <td>${fine > 0 ? window.app.formatCurrency(fine) : '-'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <div class="mt-3">
                    <p><strong>Tổng số sách:</strong> ${returnData.borrowIds.length} cuốn</p>
                    <p><strong>Phí phạt quá hạn:</strong> ${window.app.formatCurrency(totalOverdueFine)}</p>
                    <p><strong>Phí hư hỏng:</strong> ${window.app.formatCurrency(totalDamageFee)}</p>
                    <p><strong>Tổng phí phải thu:</strong> <strong class="text-danger">${window.app.formatCurrency(totalOverdueFine + totalDamageFee)}</strong></p>
                    ${returnData.note ? `<p><strong>Ghi chú:</strong> ${returnData.note}</p>` : ''}
                </div>

                <div class="row mt-4">
                    <div class="col-6 text-center">
                        <strong>Độc giả</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                    <div class="col-6 text-center">
                        <strong>Thủ thư</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                </div>
            `;

            receiptContent.innerHTML = html; //
        }

        // Generate renewal receipt
        function generateRenewalReceipt(renewalData) {
            const reader = window.dataManager.getReader(renewalData.readerId); //
            const receiptContent = document.getElementById('receiptContent'); //
            const renewalFeePerBook = 5000; //

            const totalFee = renewalData.borrowIds.length * renewalFeePerBook; //

            let html = `
                <div class="receipt-header">
                    <h4>PHIẾU GIA HẠN SÁCH</h4>
                    <p class="mb-0">Thư viện trường THPT ABC</p>
                    <small>Ngày: ${window.app.formatDateTime(new Date())}</small>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Độc giả:</strong> ${reader ? reader.fullName : 'Không tìm thấy'}<br>
                        <strong>Mã thẻ:</strong> ${renewalData.readerId}<br>
                        <strong>Lớp:</strong> ${reader ? reader.className : 'Không tìm thấy'}
                    </div>
                    <div class="col-6">
                        <strong>Ngày gia hạn:</strong> ${window.app.formatDate(renewalData.renewalDate)}<br>
                        <strong>Lý do:</strong> ${renewalData.reason}<br>
                        <strong>Thủ thư:</strong> ${window.app.currentUser?.name || 'Admin'}
                    </div>
                </div>

                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã sách</th>
                            <th>Tên sách</th>
                            <th>Hạn cũ</th>
                            <th>Hạn mới</th>
                            <th>Phí</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const maxBorrowDays = window.app.getSystemSettings().maxBorrowDays || 14;

            renewalData.borrowIds.forEach((borrowId, index) => { //
                const borrowRecord = window.dataManager.getAllBorrowRecords().find(br => br.id === borrowId); //
                const book = window.dataManager.getBook(borrowRecord.bookId); //
                const oldDue = new Date(borrowRecord.dueDate); // Use dueDate for current due date
                const newDue = new Date(oldDue);
                newDue.setDate(newDue.getDate() + maxBorrowDays); // Extend by maxBorrowDays

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${borrowRecord.bookId}</td>
                        <td>${book ? book.title : 'Không tìm thấy'}</td>
                        <td>${window.app.formatDate(borrowRecord.dueDate)}</td>
                        <td>${window.app.formatDate(newDue)}</td>
                        <td>${window.app.formatCurrency(renewalFeePerBook)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <div class="mt-3">
                    <p><strong>Tổng số sách:</strong> ${renewalData.borrowIds.length} cuốn</p>
                    <p><strong>Tổng phí gia hạn:</strong> <strong class="text-info">${window.app.formatCurrency(totalFee)}</strong></p>
                </div>

                <div class="row mt-4">
                    <div class="col-6 text-center">
                        <strong>Độc giả</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                    <div class="col-6 text-center">
                        <strong>Thủ thư</strong><br>
                        <small>(Ký tên)</small>
                    </div>
                </div>
            `;

            receiptContent.innerHTML = html; //
        }

        // Print receipt
        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML; //
            const printWindow = window.open('', '_blank'); //

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Phiếu giao dịch</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .receipt-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                </body>
                </html>
            `);

            printWindow.document.close(); //
            printWindow.print(); //
        }

        // Print daily report
        function printDailyReport() {
            window.app.showLoading('Đang tạo báo cáo hàng ngày...'); //

            setTimeout(() => {
                const today = new Date();
                const todayString = window.app.formatDate(today, 'yyyy-mm-dd');

                const dailyBorrows = window.dataManager.getBorrowRecords({ fromDate: todayString, toDate: todayString, status: 'borrowed' });
                const dailyReturns = window.dataManager.getBorrowRecords({ fromDate: todayString, toDate: todayString, status: 'returned' });
                const dailyRenewals = window.dataManager.getAllRenewals().filter(r => window.app.formatDate(r.renewalDate, 'yyyy-mm-dd') === todayString);
                const newOverdue = window.dataManager.getOverdueBooks().filter(br => window.app.formatDate(br.borrowDate, 'yyyy-mm-dd') === todayString); // Simplified: count any overdue book that was borrowed today
                const dailyFinesCollected = window.dataManager.getAllFines().filter(f => window.app.formatDate(f.paidDate, 'yyyy-mm-dd') === todayString).reduce((sum, f) => sum + f.amount, 0);


                const reportData = `
                    <div class="header" style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
                        <h1>BÁO CÁO HOẠT ĐỘNG THƯ VIỆN HÀNG NGÀY</h1>
                        <h3>${window.app.getSystemSettings().libraryName || 'Thư viện trường THPT ABC'}</h3>
                        <p>Ngày báo cáo: ${window.app.formatDate(today)}</p>
                        <p>Người lập báo cáo: ${window.app.currentUser?.name || 'Admin'}</p>
                    </div>

                    <h4 style="margin-top: 20px;">I. Tổng quan hoạt động</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Chỉ số</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">Số lượt mượn sách mới</td><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${dailyBorrows.length}</td></tr>
                            <tr><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">Số lượt trả sách</td><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${dailyReturns.length}</td></tr>
                            <tr><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">Số lượt gia hạn</td><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${dailyRenewals.length}</td></tr>
                            <tr><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">Số sách mới quá hạn</td><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${newOverdue.length}</td></tr>
                            <tr><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tổng phí phạt đã thu</td><td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${window.app.formatCurrency(dailyFinesCollected)}</td></tr>
                        </tbody>
                    </table>

                    <h4 style="margin-top: 20px;">II. Chi tiết lượt mượn sách</h4>
                    ${dailyBorrows.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Mã sách</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Tên sách</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Độc giả</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Hạn trả</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dailyBorrows.map(br => {
                                    const book = window.dataManager.getBook(br.bookId);
                                    const reader = window.dataManager.getReader(br.readerId);
                                    return `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${br.bookId}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${book ? book.title : 'Không tìm thấy'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${reader ? reader.fullName : 'Không tìm thấy'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${window.app.formatDate(br.dueDate)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p>Không có lượt mượn sách hôm nay.</p>'}

                    <h4 style="margin-top: 20px;">III. Chi tiết lượt trả sách</h4>
                    ${dailyReturns.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Mã sách</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Tên sách</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Độc giả</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f0f0f0;">Tình trạng</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dailyReturns.map(br => {
                                    const book = window.dataManager.getBook(br.bookId);
                                    const reader = window.dataManager.getReader(br.readerId);
                                    return `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${br.bookId}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${book ? book.title : 'Không tìm thấy'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${reader ? reader.fullName : 'Không tìm thấy'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${br.condition || 'Tốt'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p>Không có lượt trả sách hôm nay.</p>'}
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Báo cáo hoạt động ngày ${window.app.formatDate(today)}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f0f0f0; }
                        </style>
                    </head>
                    <body>
                        ${reportData}
                    </body>
                    </html>
                `);

                printWindow.document.close();
                printWindow.print();
                window.app.hideLoading();
            }, 1000);
        }


        // SCANNER FUNCTIONS

        // Scan reader card
        function scanReaderCard() {
            window.app.showNotification('Tính năng quét mã thẻ đang được phát triển!', 'info');
        }

        function scanReturnReaderCard() {
            window.app.showNotification('Tính năng quét mã thẻ đang được phát triển!', 'info');
        }

        function scanRenewReaderCard() {
            window.app.showNotification('Tính năng quét mã thẻ đang được phát triển!', 'info');
        }

        // Scan book barcode
        function scanBookBarcode() {
            window.app.showNotification('Tính năng quét mã vạch đang được phát triển!', 'info');
        }

        // Toggle barcode scanner
        function toggleBarcodeScanner() {
            const scanner = document.getElementById('barcodeScanner');

            if (scanner.classList.contains('active')) {
                scanner.classList.remove('active');
                scanner.innerHTML = `
                    <i class="fas fa-qrcode fa-3x text-muted mb-3"></i>
                    <h6>Quét mã vạch</h6>
                    <p class="text-muted mb-3">Nhấn để kích hoạt camera quét mã</p>
                    <button class="btn btn-outline-primary" onclick="toggleBarcodeScanner()">
                        <i class="fas fa-camera"></i> Bật camera
                    </button>
                `;
            } else {
                scanner.classList.add('active');
                scanner.innerHTML = `
                    <i class="fas fa-camera fa-3x text-success mb-3"></i>
                    <h6>Camera đang hoạt động</h6>
                    <p class="text-success mb-3">Đưa mã vạch vào khung hình</p>
                    <button class="btn btn-outline-danger" onclick="toggleBarcodeScanner()">
                        <i class="fas fa-stop"></i> Tắt camera
                    </button>
                `;

                // Simulate scanner activation
                setTimeout(() => {
                    window.app.showNotification('Tính năng quét mã vạch đang được phát triển!', 'info');
                }, 1000);
            }
        }

        // UTILITY FUNCTIONS

        // Check if a book is overdue
        function isBookOverdue(borrowRecord) {
            const today = new Date();
            const dueDate = new Date(borrowRecord.dueDate);
            // Ensure comparison is only date part, not time
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
        }

        // Calculate overdue days
        function calculateOverdueDays(dueDateString) {
            const today = new Date();
            const dueDate = new Date(dueDateString);
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            const diffTime = today - dueDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays); // Ensure days are not negative
        }

        // Get condition text
        function getConditionText(condition) {
            switch(condition) {
                case 'good': return 'Tốt';
                case 'fair': return 'Khá';
                case 'poor': return 'Kém';
                case 'damaged': return 'Hư hỏng';
                default: return 'Không rõ';
            }
        }

        // Get transaction display status
        function getTransactionDisplayStatus(record) {
            if (record.status === 'borrowed') {
                if (isBookOverdue(record)) {
                    return { class: 'status-overdue', text: 'Quá hạn' };
                }
                return { class: 'status-borrowed', text: 'Đang mượn' };
            } else if (record.status === 'returned') {
                return { class: 'status-returned', text: 'Đã trả' };
            } else if (record.status === 'renewed') {
                return { class: 'status-renewed', text: 'Đã gia hạn' };
            }
            return { class: 'bg-secondary', text: 'Không rõ' }; // Default
        }

        // Get transaction type badge class
        function getTransactionTypeBadge(type) {
            switch(type) {
                case 'borrow': return 'bg-primary';
                case 'return': return 'bg-success';
                case 'renew': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // Get transaction type text
        function getTransactionTypeText(type) {
            switch(type) {
                case 'borrow': return 'Mượn sách';
                case 'return': return 'Trả sách';
                case 'renew': return 'Gia hạn';
                default: return 'Không rõ';
            }
        }

        // View detail functions (placeholder - these would typically open modals with more info)
        function viewReaderDetail(readerId) {
            window.app.showNotification(`Xem chi tiết độc giả ID: ${readerId} (tính năng đang phát triển)`, 'info');
            // This would typically open the reader details modal from readers.html
        }

        function viewBookDetail(bookId) {
            window.app.showNotification(`Xem chi tiết sách ID: ${bookId} (tính năng đang phát triển)`, 'info');
            // This would typically open the book details modal from books.html
        }

        function viewTransactionDetail(transactionId) {
            window.app.showNotification(`Xem chi tiết giao dịch ID: ${transactionId} (tính năng đang phát triển)`, 'info');
            // This would typically open a transaction details modal
        }

        // Select for borrow functions (from search results)
        function selectReaderForBorrow(readerId) {
            const reader = window.dataManager.getReader(readerId);
            if (reader) {
                if (!canReaderBorrow(reader)) {
                    window.app.showNotification('Độc giả này không thể mượn sách!', 'error');
                    return;
                }
                selectReader(readerId); // Re-use existing selectReader logic
                // Switch to borrow tab if not already there
                const borrowTab = new bootstrap.Tab(document.getElementById('borrow-tab'));
                borrowTab.show();
                // Close search results modal if it exists (assuming this is called from a modal)
                const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal')); // If search results are in a modal
                if (searchModal) searchModal.hide();
            }
        }

        function selectBookForBorrow(bookId) {
            const book = window.dataManager.getBook(bookId);
            if (book) {
                if (book.availableCopies <= 0) {
                    window.app.showNotification('Sách này hiện không có sẵn!', 'error');
                    return;
                }
                toggleBookSelection(bookId); // Re-use existing toggleBookSelection logic
                // Switch to borrow tab if not already there
                const borrowTab = new bootstrap.Tab(document.getElementById('borrow-tab'));
                borrowTab.show();
                 // Close search results modal if it exists (assuming this is called from a modal)
                const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
                if (searchModal) searchModal.hide();
            }
        }

        // Placeholder quick action modals (can implement later if needed)
        function showPopularBooksModal() {
            window.app.showNotification('Hiển thị sách phổ biến (tính năng đang phát triển)', 'info');
        }
        function showNewBooksModal() {
            window.app.showNotification('Hiển thị sách mới (tính năng đang phát triển)', 'info');
        }
        function showRecommendedBooksModal() {
            window.app.showNotification('Gợi ý sách cho độc giả (tính năng đang phát triển)', 'info');
        }
        function showOverdueBooksModal() {
            // This could directly open the main overdue modal
            showOverdueModal();
        }
        function showDueTodayModal() {
            window.app.showNotification('Hiển thị sách hết hạn hôm nay (tính năng đang phát triển)', 'info');
        }
        function showRenewalHistoryModal() {
             window.app.showNotification('Hiển thị lịch sử gia hạn (tính năng đang phát triển)', 'info');
        }
        function showRenewalStatsModal() {
             window.app.showNotification('Hiển thị thống kê gia hạn (tính năng đang phát triển)', 'info');
        }

        // Logout function
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                window.app.logout(); // Use logout from app.js
            }
        }
    </script>
</body>
</html>
